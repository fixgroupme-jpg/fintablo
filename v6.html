<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–§–∏–Ω—Ç–∞–±–ª–æ v7</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
:root{
  --bg:#0a0e14;--sf:#0f1520;--cd:#131a28;--cd2:#1a2236;
  --bd:#1e2d42;--bd2:#283a54;
  --tx:#f1f5f9;--tx2:#94a3b8;--mt:#4b5f7a;
  --ac:#10b981;--acd:rgba(16,185,129,.08);
  --cy:#06b6d4;--cyd:rgba(6,182,212,.08);
  --gr:#10b981;--grd:rgba(16,185,129,.08);
  --rd:#ef4444;--rdd:rgba(239,68,68,.06);
  --yl:#eab308;--yld:rgba(234,179,8,.07);
  --bl:#3b82f6;--bld:rgba(59,130,246,.08);
  --or:#f59e0b;
  --tr:#6366f1;--trd:rgba(99,102,241,.08);
  --ow:#8b5cf6;--owd:rgba(139,92,246,.08);
  --it:#64748b;--itd:rgba(100,116,139,.08);
  --pk:#ec4899;
  --R:12px;
  --sh:0 1px 4px rgba(0,0,0,.3),0 0 0 1px rgba(255,255,255,.03);
  --sh-l:0 8px 24px rgba(0,0,0,.4),0 0 0 1px rgba(255,255,255,.05);
}
[data-theme="light"]{
  --bg:#f4f6f9;--sf:#ffffff;--cd:#ffffff;--cd2:#f1f5f9;
  --bd:#e2e8f0;--bd2:#cbd5e1;
  --tx:#0f172a;--tx2:#475569;--mt:#94a3b8;
  --ac:#059669;--acd:rgba(5,150,105,.06);
  --gr:#059669;--grd:rgba(5,150,105,.05);
  --rd:#dc2626;--rdd:rgba(220,38,38,.04);
  --yl:#ca8a04;--yld:rgba(202,138,4,.05);
  --bl:#2563eb;--bld:rgba(37,99,235,.05);
  --or:#d97706;
  --cy:#0891b2;--cyd:rgba(8,145,178,.06);
  --tr:#4f46e5;--trd:rgba(79,70,229,.05);
  --ow:#7c3aed;--owd:rgba(124,58,237,.05);
  --it:#64748b;--itd:rgba(100,116,139,.05);
  --pk:#db2777;
  --sh:0 1px 3px rgba(0,0,0,.04),0 0 0 1px rgba(0,0,0,.04);
  --sh-l:0 4px 12px rgba(0,0,0,.06),0 0 0 1px rgba(0,0,0,.05);
}
[data-theme="light"] .hdr{background:#fff!important;border-bottom:1px solid #e2e8f0}
[data-theme="light"] .nav{background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.04)}
[data-theme="light"] .kpi-hero{background:linear-gradient(160deg,#ecfdf5,#fff)!important}
[data-theme="light"] .od-kpi.hero{background:linear-gradient(160deg,#ecfdf5,#fff)!important}
[data-theme="light"] .pill.on,.flt-pill.on{color:#fff}
[data-theme="light"] .btn-p{color:#fff}
[data-theme="light"] .od-summary{background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(6,182,212,.02))}
[data-theme="light"] .fp-interp{background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(6,182,212,.02))}
[data-theme="light"] .auth-box{background:#fff;box-shadow:0 8px 32px rgba(0,0,0,.06)}
[data-theme="light"] .dash-pill.on{color:#fff}
[data-theme="light"] .theme-btn{background:#fff;border-color:#e2e8f0;color:#475569}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased;letter-spacing:-.01em;font-size:14px}
.mono{font-family:'Inter',sans-serif;font-variant-numeric:tabular-nums;font-weight:600}

/* Transitions */
.kpi,.kpi-hero,.od-kpi,.drow,.card,.acct-card,.fp-line,.nav-t,.pill,.btn,.flt-pill{transition:all .2s ease}
.kpi:hover,.od-kpi:hover,.acct-card:hover{transform:translateY(-2px);box-shadow:var(--sh-l)}
.drow:hover{background:var(--cd2)}

/* HEADER */
.hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 28px;background:linear-gradient(135deg,#0a1018,#101828);position:sticky;top:0;z-index:100;box-shadow:0 1px 20px rgba(0,0,0,.4)}
.logo{font-size:22px;font-weight:800;letter-spacing:-.5px;color:var(--tx)}.logo b{color:var(--ac)}
.hdr-r{display:flex;align-items:center;gap:12px}
.badge{font-size:9px;font-weight:700;padding:3px 10px;border-radius:8px;letter-spacing:.6px}
.badge-ok{background:var(--acd);color:var(--ac)}
.op-cnt{font-size:11px;color:var(--mt)}

/* NAV */
.nav{display:flex;background:var(--sf);overflow-x:auto;box-shadow:0 1px 8px rgba(0,0,0,.25)}
.nav-t{padding:14px 20px;font-size:13px;font-weight:600;color:var(--mt);cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;white-space:nowrap;display:flex;align-items:center;gap:6px;user-select:none}
.nav-t:hover{color:var(--tx2)}.nav-t.on{color:var(--ac);border-bottom-color:var(--ac)}

/* PERIOD BAR */
.pbar{display:flex;gap:8px;padding:14px 28px;align-items:center;background:var(--sf);flex-wrap:wrap;box-shadow:0 1px 6px rgba(0,0,0,.15)}
.pill{padding:7px 18px;font-size:12px;font-weight:600;border:none;border-radius:10px;background:var(--cd);color:var(--mt);cursor:pointer;transition:.15s;box-shadow:var(--sh)}
.pill:hover{color:var(--tx2);background:var(--cd2)}
.pill.on{background:var(--ac);color:#fff;font-weight:700;box-shadow:0 2px 12px rgba(16,185,129,.25)}
.month-nav{display:flex;align-items:center;gap:8px;margin-left:10px}
.mn-btn{background:var(--cd);border:none;border-radius:10px;color:var(--tx2);cursor:pointer;padding:5px 12px;font-size:12px;transition:.15s;box-shadow:var(--sh)}
.mn-btn:hover{color:var(--tx);background:var(--cd2)}
.mn-label{font-size:12px;font-weight:700;min-width:120px;text-align:center;color:var(--tx2)}
.p-info{margin-left:auto;font-size:10px;color:var(--mt)}

/* LAYOUT */
.wrap{padding:28px 28px 70px;max-width:1440px}
.scr{display:none;animation:fadeIn .3s ease}.scr.on{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ===== KPI CARDS ‚Äî FixGroup style ===== */
.kpi-g{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:16px}
.kpi{background:var(--cd);border-radius:var(--R);padding:20px 22px;box-shadow:var(--sh)}
.kpi-l{font-size:11px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}
.kpi-v{font-size:28px;font-weight:800;letter-spacing:-.5px}
.kpi-trend{font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px}
.kpi-trend .up{color:var(--gr)}.kpi-trend .dn{color:var(--rd)}.kpi-trend .flat{color:var(--mt)}
.kpi-hero{grid-column:1/-1;background:linear-gradient(160deg,#0c1424,#111d38);text-align:center;padding:32px;box-shadow:var(--sh-l)}
.kpi-hero .kpi-v{font-size:52px;font-weight:800}
.kpi-hero .kpi-l{font-size:12px;letter-spacing:2px}
.pos{color:var(--gr)}.neg{color:var(--rd)}.transit{color:var(--tr)}.owner{color:var(--ow)}.intxfer{color:var(--it)}

/* P&L ROW */
.pnl-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:16px}
.pnl{background:var(--cd);border-radius:var(--R);padding:18px 20px;text-align:center;box-shadow:var(--sh)}
.pnl-l{font-size:10px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.pnl-v{font-size:24px;font-weight:700}

/* DATA ROWS */
.dlist{display:flex;flex-direction:column;gap:10px}
.drow{background:var(--cd);border-radius:var(--R);padding:16px 20px;display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;cursor:pointer;box-shadow:var(--sh)}
.drow.expanded{box-shadow:var(--sh-l);border-bottom-left-radius:0;border-bottom-right-radius:0;margin-bottom:0}
.drow-l{display:flex;flex-direction:column;gap:6px}
.dcat{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.dcat .chevron{font-size:10px;color:var(--mt);transition:transform .2s}.drow.expanded .chevron{transform:rotate(90deg)}
.dbar-t{height:5px;background:rgba(255,255,255,.04);border-radius:3px;overflow:hidden}.dbar-f{height:100%;border-radius:3px;transition:width .6s ease-out}
.drow-r{text-align:right}.damt{font-size:15px;font-weight:700}.dpct{font-size:10px;color:var(--mt);margin-top:3px}
.drill{background:var(--cd2);border-top:1px solid rgba(255,255,255,.03);border-bottom-left-radius:var(--R);border-bottom-right-radius:var(--R);padding:8px 18px 14px;margin-bottom:10px;animation:slideDown .2s ease;box-shadow:0 4px 12px rgba(0,0,0,.2)}
@keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:300px}}
.drill-item{display:flex;justify-content:space-between;padding:8px 0;font-size:13px;border-bottom:1px solid rgba(255,255,255,.03)}
.drill-item:last-child{border-bottom:0}
.slbl{font-size:11px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;margin-top:24px}.slbl:first-child{margin-top:0}
.b0{background:var(--rd)}.b1{background:var(--or)}.b2{background:var(--yl)}.b3{background:var(--bl)}.b4{background:var(--ac)}.b5{background:var(--cy)}.b6{background:var(--gr)}.b7{background:var(--pk)}

/* EMPTY STATES */
.empty{text-align:center;padding:60px 24px;color:var(--mt)}.empty .ei{font-size:42px;margin-bottom:14px}.empty .et{font-size:16px;font-weight:700;color:var(--tx2);margin-bottom:8px}.empty .ed{font-size:13px;line-height:1.7}
.empty .cta{display:inline-block;margin-top:16px;padding:12px 24px;background:var(--ac);border:none;border-radius:var(--R);color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:.15s;box-shadow:0 2px 12px rgba(16,185,129,.25)}
.empty .cta:hover{background:#34d399}

/* BUTTONS */
.btn{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;padding:10px 20px;border-radius:var(--R);border:none;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:var(--ac);color:#fff}.btn-p:hover{background:#34d399;box-shadow:0 2px 12px rgba(16,185,129,.3)}
.btn-o{background:var(--cd);color:var(--tx2);box-shadow:var(--sh)}.btn-o:hover{color:var(--tx);background:var(--cd2)}
.btn-d{background:var(--rdd);color:var(--rd);font-size:11px;padding:7px 14px;border-radius:10px}
.btn-grp{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}

/* DROP ZONE */
.drop-z{border:2px dashed var(--bd);border-radius:18px;padding:52px 28px;text-align:center;cursor:pointer;transition:.2s;background:var(--cd);margin-bottom:22px;box-shadow:var(--sh)}
.drop-z:hover,.drop-z.over{border-color:var(--ac);background:var(--acd)}
.drop-z .dz-t{font-size:16px;font-weight:700;margin-bottom:6px}.drop-z .dz-s{font-size:12px;color:var(--mt)}
.drop-z input{display:none}

/* IMPORT TABLE */
.imp-wrap{background:var(--cd);border-radius:var(--R);overflow:hidden;margin-bottom:20px;box-shadow:var(--sh)}
.imp-bar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.04);flex-wrap:wrap;gap:8px}
.imp-info{font-size:11px;color:var(--mt)}.imp-scroll{max-height:560px;overflow-y:auto}
.imp-filter{display:flex;gap:8px;padding:10px 18px;border-bottom:1px solid rgba(255,255,255,.04);flex-wrap:wrap;align-items:center}
.flt-inp{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:7px 14px;font-size:12px;color:var(--tx);width:200px;font-family:inherit}
.flt-inp:focus{outline:none;border-color:var(--ac);box-shadow:0 0 0 2px rgba(16,185,129,.1)}
.flt-pill{padding:5px 14px;font-size:11px;font-weight:600;border:none;border-radius:8px;background:var(--sf);color:var(--mt);cursor:pointer;transition:.12s}
.flt-pill:hover{color:var(--tx2);background:var(--cd2)}.flt-pill.on{background:var(--ac);color:#fff}
.bulk-bar{display:none;padding:10px 18px;background:var(--acd);border-bottom:1px solid rgba(16,185,129,.1);align-items:center;gap:10px;flex-wrap:wrap}
.bulk-bar.show{display:flex}
.bulk-cnt{font-size:11px;font-weight:700;color:var(--ac)}

.itbl{width:100%;border-collapse:collapse;font-size:12px;table-layout:fixed}
.itbl th{text-align:left;padding:10px 12px;font-size:9px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid rgba(255,255,255,.04);background:var(--sf);position:sticky;top:0;z-index:2}
.itbl td{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:top;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5}
.itbl tr:hover td{background:rgba(16,185,129,.02)}
.itbl tr.hidden{display:none}
.itbl .c-cb{width:28px;text-align:center}.itbl .c-date{width:76px;white-space:nowrap}.itbl .c-dir{width:20px;text-align:center}.itbl .c-amt{width:84px;text-align:right;font-weight:700;white-space:nowrap}
.itbl .c-desc{width:22%}.itbl .c-cp{width:16%;color:var(--tx2)}.itbl .c-sel{width:13%}
.tsel{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:6px 10px;font-size:11px;color:var(--tx);font-family:inherit;cursor:pointer;width:100%;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' fill='%234b5f7a'%3E%3Cpath d='M1 2l3 3 3-3'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:20px}
.tsel:focus{outline:none;border-color:var(--ac)}
.tsel.auto{border-color:rgba(16,185,129,.3);color:var(--gr)}.tsel.manual{border-color:rgba(59,130,246,.3);color:var(--bl)}
.rem-cb{display:flex;align-items:center;gap:4px;font-size:9px;color:var(--mt);cursor:pointer;white-space:nowrap}.rem-cb input,.itbl .c-cb input{accent-color:var(--ac);width:14px;height:14px}

.stats-b{display:flex;gap:16px;flex-wrap:wrap;padding:14px 18px;background:var(--cd);border-radius:var(--R);margin-bottom:16px;font-size:12px;box-shadow:var(--sh)}
.st{display:flex;gap:5px;align-items:center}.st-l{color:var(--mt)}.st-v{font-weight:700}

/* FORM */
.form-card{background:var(--cd);border-radius:var(--R);padding:24px;margin-bottom:22px;box-shadow:var(--sh)}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-bottom:14px}
.form-g{display:flex;flex-direction:column;gap:5px}
.form-g label{font-size:10px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px}
.form-g input,.form-g select{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--tx);font-family:inherit;transition:border-color .15s}
.form-g input:focus,.form-g select:focus{outline:none;border-color:var(--ac);box-shadow:0 0 0 2px rgba(16,185,129,.08)}

/* RECENT OPS */
.rop{background:var(--cd);border-radius:var(--R);padding:12px 18px;display:grid;grid-template-columns:4px 72px 20px 88px 1fr 1fr auto;align-items:center;gap:10px;font-size:12px;box-shadow:var(--sh)}
.rop:hover{transform:translateY(-1px);box-shadow:var(--sh-l)}
.rop-bar{width:4px;height:100%;border-radius:2px;min-height:20px}

/* CRUD TABLE */
.ctbl{width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px}
.ctbl th{text-align:left;padding:10px 12px;font-size:9px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid rgba(255,255,255,.04);background:var(--sf)}
.ctbl td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
.ctbl tr:hover td{background:rgba(16,185,129,.02)}.ctbl .inactive{opacity:.35}
.tag{display:inline-block;padding:3px 10px;border-radius:8px;font-size:9px;font-weight:700;letter-spacing:.3px}
.tag-in{background:var(--grd);color:var(--gr)}.tag-tr{background:var(--trd);color:var(--tr)}.tag-off{background:var(--rdd);color:var(--rd)}

/* RULES */
.rtbl{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:16px}
.rtbl td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.03)}
.rinp{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:7px 12px;font-size:11px;color:var(--tx);width:100%;font-family:inherit}.rinp:focus{outline:none;border-color:var(--ac)}
.smap-row{display:grid;grid-template-columns:1fr 24px 1fr 1fr 28px;gap:8px;align-items:center;margin-bottom:6px;font-size:12px}
.smap-from{background:var(--cd);border-radius:10px;padding:10px 14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;box-shadow:var(--sh)}
.smap-to{background:var(--acd);border-radius:10px;padding:10px 14px;color:var(--ac);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.smap-arr{text-align:center;color:var(--mt)}

/* ===== DASHBOARD ‚Äî FixGroup style ===== */
.od-ctx{font-size:12px;color:var(--mt);margin-bottom:20px;display:flex;align-items:center;gap:8px}
.od-ctx b{color:var(--tx2);font-weight:700}
.od-section{margin-bottom:28px}
.od-section-title{font-size:11px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.od-section-title::after{content:'';flex:1;height:1px;background:var(--bd)}

/* Hero KPI ‚Äî one big number */
.od-kpi-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
.od-kpi{background:var(--cd);border-radius:var(--R);padding:20px 22px;box-shadow:var(--sh)}
.od-kpi:hover{transform:translateY(-2px);box-shadow:var(--sh-l)}
.od-kpi .k-label{font-size:10px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px}
.od-kpi .k-val{font-size:24px;font-weight:800;letter-spacing:-.5px}
.od-kpi.hero{background:linear-gradient(160deg,#0c1424 0%,#0f1d35 60%,#131a28 100%);box-shadow:var(--sh-l);padding:28px}
.od-kpi.hero .k-val{font-size:44px}
.od-kpi .k-sub{font-size:10px;color:var(--mt);margin-top:4px}

/* Income cards */
.od-inc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.od-inc-card{background:var(--cd);border-radius:var(--R);padding:20px 22px;box-shadow:var(--sh)}
.od-inc-card .ic-name{font-size:12px;font-weight:700;color:var(--tx2);margin-bottom:10px}
.od-inc-card .ic-val{font-size:22px;font-weight:800;letter-spacing:-.3px}
.od-inc-card .ic-trend{font-size:11px;margin-top:6px}
.od-inc-card .ic-trend .up{color:var(--gr)}.od-inc-card .ic-trend .dn{color:var(--rd)}.od-inc-card .ic-trend .flat{color:var(--mt)}
.od-inc-card .ic-pct{font-size:10px;color:var(--mt);margin-top:3px}

/* Expense rows */
.od-exp-list{display:flex;flex-direction:column;gap:10px}
.od-exp-row{display:grid;grid-template-columns:160px 1fr 110px;align-items:center;gap:14px;background:var(--cd);border-radius:var(--R);padding:14px 20px;box-shadow:var(--sh)}
.od-exp-row .e-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.od-exp-row .e-bar{height:6px;background:rgba(255,255,255,.04);border-radius:3px;overflow:hidden}.od-exp-row .e-fill{height:100%;border-radius:3px;transition:width .5s ease}
.od-exp-row .e-val{text-align:right;font-size:13px;font-weight:700}
.od-exp-row .e-pct{font-size:10px;color:var(--mt)}

/* Anomalies */
.od-anomaly{display:flex;align-items:flex-start;gap:12px;padding:14px 18px;background:var(--yld);border-radius:var(--R);margin-bottom:8px;font-size:13px;line-height:1.6;box-shadow:var(--sh)}
.od-anomaly .a-icon{font-size:14px;flex-shrink:0}
.od-anomaly.ok{background:var(--grd)}

/* Summary */
.od-summary{background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(6,182,212,.03));border-radius:var(--R);padding:22px 26px;font-size:14px;line-height:1.8;color:var(--tx);box-shadow:var(--sh)}
.od-summary b{color:var(--ac);font-weight:700}

/* Dashboard position card */
.od-pos-card{background:var(--cd);border-radius:var(--R);padding:20px 22px;box-shadow:var(--sh);cursor:pointer;margin-top:4px}
.od-pos-card:hover{transform:translateY(-2px);box-shadow:var(--sh-l)}
.od-pos-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:18px;align-items:center}
.od-pos-main{display:flex;flex-direction:column;gap:2px}
.od-pos-val{font-size:26px;font-weight:800;letter-spacing:-.5px}
.od-pos-label{font-size:9px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.6px}
.od-pos-item{display:flex;flex-direction:column;gap:2px}
.od-pos-item .p-val{font-size:16px;font-weight:700;letter-spacing:-.3px}
.od-pos-item .p-lbl{font-size:9px;color:var(--mt);font-weight:600}
.od-pos-go{font-size:10px;color:var(--ac);font-weight:700;margin-top:6px;display:flex;align-items:center;gap:4px}

/* ===== FINANCIAL POSITION ===== */
.fp-date{font-size:11px;color:var(--mt);margin-bottom:20px;text-align:right}
.fp-block{background:var(--cd);border-radius:16px;padding:24px 26px;margin-bottom:18px;box-shadow:var(--sh)}
.fp-block-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.fp-block-title{font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--tx2)}
.fp-block-total{font-size:26px;font-weight:800;letter-spacing:-.3px}
.fp-line{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.fp-line:last-child{border-bottom:0}
.fp-line-name{font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px}
.fp-line-name .fp-type{font-size:8px;font-weight:700;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.4px;flex-shrink:0}
.fp-type-account{background:var(--bld);color:var(--bl)}.fp-type-card{background:var(--yld);color:var(--yl)}
.fp-type-service{background:var(--trd);color:var(--tr)}.fp-type-reserve{background:var(--grd);color:var(--gr)}
.fp-type-client{background:var(--rdd);color:var(--rd)}.fp-type-transit{background:var(--owd);color:var(--ow)}
.fp-type-accrued{background:var(--yld);color:var(--yl)}.fp-type-other{background:var(--itd);color:var(--it)}
.fp-line-amt{font-size:15px;font-weight:700;text-align:right;white-space:nowrap}
.fp-line-comment{font-size:11px;color:var(--mt);grid-column:1/-1;padding-left:24px;margin-top:-2px}

/* Net position hero */
.fp-net{text-align:center;padding:36px 24px;border-radius:16px;margin-bottom:20px;box-shadow:var(--sh)}
.fp-net.plus{background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(16,185,129,.02))}
.fp-net.edge{background:linear-gradient(135deg,rgba(234,179,8,.06),rgba(234,179,8,.02))}
.fp-net.minus{background:linear-gradient(135deg,rgba(239,68,68,.06),rgba(239,68,68,.02))}
.fp-net-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--mt);margin-bottom:10px}
.fp-net-val{font-size:40px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px}
.fp-net-status{font-size:14px;font-weight:700}
.fp-interp{background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(6,182,212,.02));border-radius:var(--R);padding:22px 26px;font-size:14px;line-height:1.8;color:var(--tx);margin-bottom:24px;box-shadow:var(--sh)}
.fp-interp b{color:var(--ac);font-weight:700}
.fp-add-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.fp-entry-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.fp-entry-row:last-child{border-bottom:0}
.fp-off{opacity:.3;text-decoration:line-through}
.fp-block-sub{font-size:9px;color:var(--mt);margin-top:2px}
.fp-section-sep{height:1px;background:rgba(255,255,255,.03);margin:8px 0}
.fp-liq-tag{font-size:8px;font-weight:700;padding:2px 7px;border-radius:6px;letter-spacing:.3px;text-transform:uppercase;margin-left:6px}
.fp-liq-h{background:rgba(16,185,129,.1);color:var(--gr)}.fp-liq-m{background:rgba(234,179,8,.08);color:var(--yl)}.fp-liq-l{background:rgba(100,116,139,.1);color:var(--it)}
.fp-line-conf{display:none}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--cd);border-radius:var(--R);padding:14px 24px;font-size:13px;font-weight:600;box-shadow:var(--sh-l);z-index:1000;transform:translateY(80px);opacity:0;transition:.25s}
.toast.show{transform:translateY(0);opacity:1}.toast.ok{color:var(--gr);box-shadow:var(--sh-l),0 0 0 1px rgba(16,185,129,.15)}.toast.err{color:var(--rd);box-shadow:var(--sh-l),0 0 0 1px rgba(239,68,68,.15)}.toast.warn{color:var(--yl);box-shadow:var(--sh-l),0 0 0 1px rgba(234,179,8,.15)}
.danger-zone{margin-top:32px;padding-top:22px;border-top:1px solid rgba(255,255,255,.04)}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,12,.75);backdrop-filter:blur(6px);z-index:200;display:flex;align-items:center;justify-content:center}
.modal{background:var(--cd);border-radius:18px;padding:28px;width:460px;max-width:92vw;max-height:85vh;overflow-y:auto;box-shadow:0 8px 48px rgba(0,0,0,.5)}.modal h3{font-size:17px;margin-bottom:16px}

/* ACCOUNTS */
.acct-cat-group{margin-bottom:28px}
.acct-cat-hdr{display:flex;justify-content:space-between;align-items:center;font-size:14px;font-weight:700;color:var(--tx2);margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.04)}
.acct-card{background:var(--cd);border-radius:var(--R);padding:18px 22px;margin-bottom:10px;box-shadow:var(--sh)}
.acct-card.acct-off{opacity:.35}
.acct-card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.acct-card-name{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}
.acct-card-bal{font-size:18px;font-weight:800;letter-spacing:-.3px}
.acct-card-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.acct-card-comment{font-size:11px;color:var(--mt);margin-bottom:6px}
.acct-card-actions{display:flex;gap:6px;justify-content:flex-end}
.acct-personal{font-size:9px;font-weight:700;color:var(--yl);background:var(--yld);padding:2px 8px;border-radius:6px;margin-left:4px}
.acct-liq{font-size:9px;font-weight:700;padding:2px 8px;border-radius:6px}
.liq-h{background:var(--grd);color:var(--gr)}.liq-m{background:var(--yld);color:var(--yl)}.liq-l{background:rgba(100,116,139,.08);color:var(--it)}
.acct-tag{font-size:9px;font-weight:600;padding:2px 8px;border-radius:6px}
.acct-tag-cash{background:var(--acd);color:var(--ac)}.acct-tag-liab{background:var(--rdd);color:var(--rd)}

/* Obligation filter */
.obl-filter-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.obl-filter-pill{font-size:10px;padding:4px 12px;border-radius:8px;cursor:pointer;border:1px solid var(--bd);background:transparent;color:var(--mt);transition:all .15s;font-weight:600}
.obl-filter-pill.on{background:var(--rdd);color:var(--rd);border-color:var(--rd)}
.obl-filter-pill .obl-cnt{font-weight:800;margin-left:3px}
.obl-group-hdr{font-size:10px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.6px;padding:8px 0 4px;border-top:1px solid var(--bd);margin-top:6px}
.obl-group-hdr:first-child{border-top:none;margin-top:0;padding-top:2px}
.obl-flag{display:inline-flex;align-items:center;gap:3px;font-size:8px;padding:1px 6px;border-radius:4px;margin-left:6px}
.obl-flag-foreign{background:rgba(239,68,68,.15);color:var(--rd)}
.obl-flag-settled{background:rgba(59,130,246,.15);color:var(--bl)}

/* AUTH */
#authScreen{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center}
#authScreen.hidden{display:none}
.auth-box{background:var(--cd);border-radius:20px;padding:44px 40px;width:100%;max-width:400px;box-shadow:0 12px 48px rgba(0,0,0,.4)}
.auth-logo{text-align:center;font-size:30px;font-weight:800;margin-bottom:6px;letter-spacing:-1px;color:var(--tx)}
.auth-logo b{color:var(--ac)}
.auth-sub{text-align:center;font-size:13px;color:var(--mt);margin-bottom:30px}
.auth-box .form-g{margin-bottom:16px}
.auth-box .form-g label{font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:4px;display:block}
.auth-box .form-g input{width:100%;padding:13px 16px;background:var(--sf);border:1px solid var(--bd);border-radius:10px;color:var(--tx);font-size:14px;box-sizing:border-box}
.auth-box .form-g input:focus{border-color:var(--ac);outline:none}
.auth-err{color:var(--rd);font-size:11px;margin-bottom:10px;min-height:16px;text-align:center}
.auth-btn{width:100%;padding:14px;background:var(--ac);color:#fff;border:none;border-radius:var(--R);font-size:15px;font-weight:700;cursor:pointer;margin-top:4px;transition:.15s}
.auth-btn:hover{background:#34d399;box-shadow:0 2px 12px rgba(16,185,129,.3)}
.auth-btn:disabled{opacity:.5;cursor:wait}
.auth-switch{text-align:center;margin-top:18px;font-size:12px;color:var(--mt)}
.auth-switch a{color:var(--ac);cursor:pointer;text-decoration:underline}
.usr-pill{font-size:10px;background:var(--sf);padding:5px 12px;border-radius:8px;color:var(--mt);cursor:pointer;display:flex;align-items:center;gap:6px}
.usr-pill:hover{background:var(--bd)}

/* Responsive */
@media(max-width:900px){.od-kpi-strip{grid-template-columns:repeat(3,1fr)}.od-inc-grid{grid-template-columns:1fr}.od-exp-row{grid-template-columns:100px 1fr 80px}.kpi-g{grid-template-columns:repeat(2,1fr)}.kpi-hero{grid-column:1/-1}.pnl-row{grid-template-columns:1fr}.od-pos-row{grid-template-columns:1fr 1fr;gap:10px}}
@media(max-width:700px){.wrap{padding:18px 16px 50px}.pbar,.hdr{padding-left:16px;padding-right:16px}.form-row{grid-template-columns:1fr}.imp-scroll{max-height:400px}.flt-inp{width:140px}}
@media(max-width:600px){.od-kpi-strip{grid-template-columns:repeat(2,1fr)}.acct-card-top{flex-direction:column;align-items:flex-start;gap:4px}.od-pos-row{grid-template-columns:1fr}}
</style>
<style>
.theme-toggle{position:fixed;bottom:20px;right:20px;z-index:999;display:flex;gap:8px;align-items:center}
.theme-btn{padding:10px 16px;border-radius:10px;border:1px solid var(--bd);background:var(--cd);color:var(--tx2);cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;transition:all .2s;box-shadow:var(--sh)}
.theme-btn:hover{color:var(--tx);border-color:var(--ac);background:var(--cd2)}
</style>
</head>
<body>
<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">–§–∏–Ω<b>—Ç–∞–±–ª–æ</b></div>
    <div class="auth-sub" id="authSub">–í–æ–π–¥–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è</div>
    <div id="authForm">
      <div class="form-g"><label>Email</label><input type="email" id="authEmail" placeholder="you@company.ru" onkeydown="if(event.key==='Enter')doAuth()"></div>
      <div class="form-g"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="authPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doAuth()"></div>
      <div class="form-g" id="authNameWrap" style="display:none"><label>–ò–º—è</label><input type="text" id="authName" placeholder="–ò–≤–∞–Ω"></div>
      <div class="auth-err" id="authErr"></div>
      <button class="auth-btn" id="authBtn" onclick="doAuth()">–í–æ–π—Ç–∏</button>
      <div class="auth-switch" id="authSwitch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleAuthMode()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
      <div style="border-top:1px solid var(--bd);margin-top:20px;padding-top:16px;text-align:center">
        <div style="font-size:11px;color:var(--mt);margin-bottom:8px">–ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
        <button class="auth-btn" style="background:var(--sf);color:var(--tx);border:1px solid var(--bd);font-size:13px;padding:12px" onclick="startDemo()">üöÄ –î–µ–º–æ-—Ä–µ–∂–∏–º</button>
        <div style="font-size:10px;color:var(--mt);margin-top:6px">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
      </div>
    </div>
  </div>
</div>

<div id="appWrap" style="display:none">
<div class="hdr"><div class="logo">–§–∏–Ω<b>—Ç–∞–±–ª–æ</b></div><div class="hdr-r"><div class="usr-pill" id="usrPill" onclick="showUserMenu()"><span id="usrName">‚Äî</span><span>‚ñæ</span></div><span class="op-cnt mono" id="opCnt">‚Äî</span><span class="badge badge-ok mono">v7</span></div></div>
<div class="nav">
  <div class="nav-t on" data-s="dash">üìä –û–±–∑–æ—Ä</div>
  <div class="nav-t" data-s="exp">üìâ –†–∞—Å—Ö–æ–¥—ã</div>
  <div class="nav-t" data-s="inc">üìà –î–æ—Ö–æ–¥—ã</div>
  <div class="nav-t" data-s="fp">üí∞ –ë–∞–ª–∞–Ω—Å</div>
  <div class="nav-t" data-s="acct">üè¶ –°—á–µ—Ç–∞</div>
  <div class="nav-t" data-s="imp">üì• –ó–∞–≥—Ä—É–∑–∫–∞</div>
  <div class="nav-t" data-s="add">‚úèÔ∏è + –û–ø–µ—Ä–∞—Ü–∏—è</div>
  <div class="nav-t" data-s="ref">üìö –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
  <div class="nav-t" data-s="rules">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>
<div class="pbar" id="pbar">
  <button class="pill on" data-p="month">–ú–µ—Å—è—Ü</button>
  <button class="pill" data-p="week">–ù–µ–¥–µ–ª—è</button>
  <button class="pill" data-p="quarter">–ö–≤–∞—Ä—Ç–∞–ª</button>
  <button class="pill" data-p="all">–í—Å—ë</button>
  <div class="month-nav" id="monthNav">
    <button class="mn-btn" onclick="shiftMonth(-1)">‚óÄ</button>
    <span class="mn-label mono" id="mnLabel"></span>
    <button class="mn-btn" onclick="shiftMonth(1)">‚ñ∂</button>
  </div>
  <span class="p-info mono" id="pInfo"></span>
</div>
<div class="wrap">

<div id="s-dash" class="scr on">
  <div class="od-ctx" id="odCtx"></div>
  <div class="od-section"><div class="od-section-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Å—è—Ü–∞</div><div class="od-kpi-strip mono" id="odKpi"></div></div>
  <div class="od-section"><div class="od-section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ—Ö–æ–¥–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</div><div class="od-inc-grid mono" id="odInc"></div></div>
  <div class="od-section"><div class="od-section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ¬∑ —Ç–æ–ø-5 –∑–∞ –Ω–µ–¥–µ–ª—é</div><div class="od-exp-list" id="odExp"></div></div>
  <div class="od-section" id="odAnoSec" style="display:none"><div class="od-section-title">–ê–Ω–æ–º–∞–ª–∏–∏ –Ω–µ–¥–µ–ª–∏</div><div id="odAno"></div></div>
  <div class="od-section"><div class="od-section-title">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è</div><div id="odPos"></div></div>
  <div class="od-section"><div class="od-summary" id="odSum"></div></div>
</div>

<div id="s-exp" class="scr">
  <div class="slbl">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–±–µ–∑ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö)</div><div class="dlist" id="expCatL"></div>
</div>

<div id="s-inc" class="scr">
  <div class="slbl">–î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—Ç–æ–ª—å–∫–æ income)</div><div class="dlist" id="incCatL"></div>
</div>

<!-- FINANCIAL POSITION REPORT -->
<div id="s-fp" class="scr">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
    <div class="fp-date" id="fpDate" style="margin:0"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-p" onclick="openAcctModal()">+ –°—á—ë—Ç</button>
      <button class="btn btn-o" onclick="openFpModal('asset')">+ –ê–∫—Ç–∏–≤</button>
      <button class="btn btn-o" onclick="openOblModal()">+ –û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</button>
    </div>
  </div>
  <div class="fp-net" id="fpNet"></div>
  <div class="fp-interp" id="fpInterp"></div>

  <div class="fp-block">
    <div class="fp-block-hdr"><span class="fp-block-title" style="color:var(--gr)">üí∞ –õ–∏–∫–≤–∏–¥–Ω—ã–µ –∞–∫—Ç–∏–≤—ã</span><span class="fp-block-total mono pos" id="fpLiqTotal">‚Äî</span></div>
    <div id="fpLiqLines"></div>
  </div>

  <div class="fp-block">
    <div class="fp-block-hdr"><span class="fp-block-title" style="color:var(--bl)">üìä –ü—Ä–æ—á–∏–µ –∞–∫—Ç–∏–≤—ã</span><span class="fp-block-total mono" id="fpOtherTotal" style="color:var(--tx2)">‚Äî</span></div>
    <div id="fpOtherLines"></div>
  </div>

  <div class="fp-block">
    <div class="fp-block-hdr"><span class="fp-block-title" style="color:var(--yl)">üìÑ –î–µ–±–∏—Ç–æ—Ä–∫–∞</span><span class="fp-block-total mono" id="fpRecvTotal" style="color:var(--yl)">‚Äî</span></div>
    <div id="fpRecvLines"></div>
  </div>

  <div class="fp-block">
    <div class="fp-block-hdr"><span class="fp-block-title" style="color:var(--rd)">‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</span><span class="fp-block-total mono neg" id="fpLiabTotal">‚Äî</span></div>
    <div id="oblFilterBar" class="obl-filter-bar"></div>
    <div id="fpLiabLines"></div>
    <div class="fp-add-bar"><button class="btn btn-o" style="font-size:11px;padding:6px 12px" onclick="openOblModal()">+ –û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</button></div>
  </div>

  <div class="fp-block" style="margin-top:24px;border-color:rgba(59,130,246,.2)">
    <div class="fp-block-hdr"><span class="fp-block-title" style="color:var(--bl)">üè¶ –ù–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏</span><span class="fp-block-total mono" id="obTotal">‚Äî</span></div>
    <p style="font-size:11px;color:var(--mt);margin-bottom:12px">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –ù–µ –¥–æ—Ö–æ–¥ –∏ –Ω–µ —Ä–∞—Å—Ö–æ–¥ ‚Äî —á–∏—Å—Ç—ã–π —Ñ–∞–∫—Ç –Ω–∞ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —É—á—ë—Ç–∞.</p>
    <div id="obLines"></div>
    <div class="fp-add-bar"><button class="btn btn-o" style="font-size:11px;padding:6px 12px" onclick="openObModal()">+ –°—á—ë—Ç / –∫–∞—Ä—Ç–∞ / —Å–µ—Ä–≤–∏—Å</button></div>
  </div>
</div>

<!-- ACCOUNTS -->
<div id="s-acct" class="scr">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px">
    <div><div class="slbl" style="margin:0">–°—á–µ—Ç–∞ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–µ–Ω–µ–≥</div><div style="font-size:12px;color:var(--mt);margin-top:4px">–ù–µ –¥–æ—Ö–æ–¥—ã –∏ –Ω–µ —Ä–∞—Å—Ö–æ–¥—ã. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏.</div></div>
    <button class="btn btn-p" onclick="openAcctModal()">+ –°—á—ë—Ç</button>
  </div>
  <div id="acctList"></div>
</div>

<div id="s-imp" class="scr">
  <div class="slbl">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫—É—é –≤—ã–ø–∏—Å–∫—É</div>
  <div class="form-card" style="margin-bottom:14px;padding:14px 18px">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <label style="font-size:12px;font-weight:700;color:var(--tx2);white-space:nowrap">–°—á—ë—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:</label>
      <select id="impAcct" style="flex:1;min-width:200px;padding:8px 12px;font-size:13px;border-radius:10px;background:var(--sf);color:var(--tx);border:1px solid var(--bd)">
        <option value="">‚Äî –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ (–æ–±—â–∏–π) ‚Äî</option>
      </select>
      <span style="font-size:10px;color:var(--mt)">–ü—Ä–∏–≤—è–∂–∏ –≤—ã–ø–∏—Å–∫—É –∫ —Ä–∞—Å—á—ë—Ç–Ω–æ–º—É —Å—á—ë—Ç—É –∏–ª–∏ –∫–∞—Ä—Ç–µ</span>
    </div>
  </div>
  <div class="drop-z" id="dropZ"><div class="dz-t">üìÇ –ü–µ—Ä–µ—Ç–∞—â–∏ CSV/Excel –∏–ª–∏ –Ω–∞–∂–º–∏</div><div class="dz-s">–¢–æ—á–∫–∞ ¬∑ –¢–∏–Ω—å–∫–æ—Ñ—Ñ ¬∑ –°–±–µ—Ä ¬∑ –ê–ª—å—Ñ–∞ ¬∑ –ª—é–±–æ–π CSV</div><input type="file" id="fInp" accept=".csv,.tsv,.xlsx,.xls"></div>
  <div id="impArea" style="display:none">
    <div class="stats-b" id="impStats"></div>
    <div class="imp-wrap">
      <div class="imp-bar"><span class="imp-info" id="impInfo"></span><button class="btn btn-o" style="font-size:11px;padding:6px 12px" onclick="autoMapAll()">ü§ñ –ê–≤—Ç–æ–º–∞–ø–ø–∏–Ω–≥</button></div>
      <div class="imp-filter" id="impFilter">
        <input class="flt-inp" id="fltQ" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é / –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—É" oninput="applyFilters()">
        <button class="flt-pill on" data-ft="all" onclick="setFlt(this)">–í—Å–µ</button>
        <button class="flt-pill" data-ft="nocat" onclick="setFlt(this)">‚ùå –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
        <button class="flt-pill" data-ft="out" onclick="setFlt(this)">üì§ –†–∞—Å—Ö–æ–¥—ã</button>
        <button class="flt-pill" data-ft="in" onclick="setFlt(this)">üì• –î–æ—Ö–æ–¥—ã</button>
      </div>
      <div class="bulk-bar" id="bulkBar">
        <span class="bulk-cnt" id="bulkCnt">0 –≤—ã–±—Ä–∞–Ω–æ</span>
        <select class="tsel" id="bulkType" style="width:130px" onchange="bulkSetType()"><option value="">–¢–∏–ø ‚Üí</option><option value="out">üì§ –†–∞—Å—Ö–æ–¥</option><option value="in">üì• –î–æ—Ö–æ–¥</option><option value="transit">üîÑ –¢—Ä–∞–Ω–∑–∏—Ç</option><option value="owner">üí∏ –î–∏–≤–∏–¥–µ–Ω–¥—ã</option><option value="internal">‚ÜîÔ∏è –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π</option></select>
        <select class="tsel" id="bulkCat" style="width:180px" onchange="bulkSetCat()"><option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí</option></select>
        <label class="rem-cb"><input type="checkbox" id="bulkRem"> –ó–∞–ø–æ–º–Ω–∏—Ç—å –≤—Å–µ</label>
      </div>
      <div class="imp-scroll"><table class="itbl"><thead><tr>
        <th class="c-cb"><input type="checkbox" id="cbAll" onchange="toggleAll(this.checked)"></th>
        <th class="c-date">–î–∞—Ç–∞</th><th class="c-dir">‚Üï</th><th class="c-amt">–°—É–º–º–∞</th>
        <th class="c-desc">–û–ø–∏—Å–∞–Ω–∏–µ</th><th class="c-cp">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
        <th class="c-sel">–¢–∏–ø</th><th class="c-sel">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th style="width:38px">–ó–∞–ø.</th>
      </tr></thead><tbody id="impBody"></tbody></table></div>
    </div>
    <div class="btn-grp">
      <button class="btn btn-p" onclick="confirmImport()">‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn btn-o" onclick="cancelImport()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<div id="s-add" class="scr">
  <div class="slbl">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é</div>
  <div class="form-card">
    <div class="form-row">
      <div class="form-g"><label>–î–∞—Ç–∞</label><input type="date" id="mDate"></div>
      <div class="form-g"><label>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label><select id="mType" onchange="onMTypeChange()"><option value="out">üì§ –†–∞—Å—Ö–æ–¥</option><option value="in">üì• –î–æ—Ö–æ–¥</option><option value="transit">üîÑ –¢—Ä–∞–Ω–∑–∏—Ç</option><option value="owner">üí∏ –î–∏–≤–∏–¥–µ–Ω–¥—ã</option><option value="internal">‚ÜîÔ∏è –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π</option></select></div>
      <div class="form-g"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" id="mAmt" placeholder="50000" min="0" step="100"></div>
    </div>
    <div class="form-row">
      <div class="form-g" id="mCatWrap"><label id="mCatLabel">–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞</label><select id="mCat"></select></div>
      <div class="form-g"><label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label><input type="text" id="mCp" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞"></div>
      <div class="form-g"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="mCm" placeholder="–ü–æ—è—Å–Ω–µ–Ω–∏–µ"></div>
    </div>
    <div class="btn-grp"><button class="btn btn-p" onclick="addManual()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button></div>
  </div>
  <div class="slbl">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div><div id="recentOps" class="dlist"></div>
</div>

<div id="s-ref" class="scr">
  <div class="slbl">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ (5 —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)</div>
  <table class="ctbl" id="tblIncCat"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead><tbody></tbody></table>
  <div class="slbl">–í–∏–¥—ã —É—Å–ª—É–≥ (–¥–æ—Ö–æ–¥)</div>
  <table class="ctbl" id="tblSvc"><thead><tr><th>–£—Å–ª—É–≥–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞</th><th>–¢–∏–ø –¥–µ–Ω–µ–≥</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead><tbody></tbody></table>
  <div class="btn-grp" style="margin-bottom:20px"><button class="btn btn-o" onclick="openAddModal('svc')">+ –í–∏–¥ —É—Å–ª—É–≥–∏</button></div>
  <div class="slbl">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (7 —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)</div>
  <table class="ctbl" id="tblExpCat"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead><tbody></tbody></table>
  <div class="slbl">–í–∏–¥—ã —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
  <table class="ctbl" id="tblExpType"><thead><tr><th>–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead><tbody></tbody></table>
  <div class="btn-grp"><button class="btn btn-o" onclick="openAddModal('expType')">+ –í–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞</button></div>
</div>

<div id="s-rules" class="scr">
  <div class="slbl">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</div>
  <p style="font-size:12px;color:var(--tx2);margin-bottom:12px">–ß–µ–∫–±–æ–∫—Å ¬´–ó–∞–ø.¬ª –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–≤—è–∑–∫—É.</p>
  <div id="savedMapList" class="dlist" style="margin-bottom:24px"></div>
  <div class="slbl">–ê–≤—Ç–æ–ø—Ä–∞–≤–∏–ª–∞ (regex ‚Üí —Ä–∞—Å—Ö–æ–¥ / –¥–æ—Ö–æ–¥ / —Å–ø–µ—Ü—Ç–∏–ø)</div>
  <table class="rtbl" id="rulesTable"><tbody></tbody></table>
  <div class="btn-grp"><button class="btn btn-o" style="font-size:12px;padding:7px 14px" onclick="addRule()">+ –ü—Ä–∞–≤–∏–ª–æ</button><button class="btn btn-p" onclick="saveRules()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  <div class="slbl">–ù–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏</div>
  <div class="form-card" style="padding:14px 18px"><div style="display:flex;gap:10px;align-items:center"><span style="font-size:13px;color:var(--tx2)" id="obSummary">‚Äî</span><button class="btn btn-o" style="font-size:12px;padding:7px 14px" onclick="goTab('fp')">‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ ¬´–ü–æ–∑–∏—Ü–∏—è¬ª</button></div></div>
  <div class="danger-zone"><div class="slbl" style="color:var(--tx2)">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</div><div class="btn-grp" style="margin-bottom:20px">
    <button class="btn btn-p" onclick="exportBackup()">üì• –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø (JSON)</button>
    <button class="btn btn-o" onclick="$('_backupInp').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –±—ç–∫–∞–ø</button>
    <input type="file" id="_backupInp" accept=".json" style="display:none" onchange="importBackup(this.files[0])">
  </div>
  <div class="slbl" style="color:var(--rd)">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div><div class="btn-grp">
    <button class="btn btn-d" onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏?')){DB.ops=[];save();renderAll();toast('–£–¥–∞–ª–µ–Ω–æ')}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏</button>
    <button class="btn btn-d" onclick="fullReset()">üí£ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å</button>
  </div></div>
</div>

</div>
</div><!-- /appWrap -->
<div id="modalWrap"></div><div class="toast" id="toast"></div>

<script>
// ========== SEED DATA ==========
const SEED_INC_CATS=[{id:'ic1',name:'–û—Å–Ω–æ–≤–Ω–∞—è –≤—ã—Ä—É—á–∫–∞',desc:'–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫',active:true},{id:'ic2',name:'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞',desc:'–î–æ–ø—Ä–æ–¥–∞–∂–∏, –ò–ò-–ø—Ä–æ–¥—É–∫—Ç—ã',active:true},{id:'ic3',name:'–†–∞–∑–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏',desc:'–ê–≥–µ–Ω—Ç—Å–∫–∏–µ, —Ä–∞–∑–æ–≤—ã–µ',active:true},{id:'ic4',name:'–í–æ–∑–≤—Ä–∞—Ç—ã / –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏',desc:'–ö–µ—à–±–µ–∫, –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏',active:true},{id:'ic5',name:'–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã',desc:'–†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ',active:true}];
const SEED_SVCS=[
  {id:'s01',name:'–õ–∏–¥—ã –ö–¶',catId:'ic1',moneyType:'income',active:true},{id:'s02',name:'–ë—Ä–µ–Ω–¥–æ–≤—ã–µ',catId:'ic2',moneyType:'income',active:true},
  {id:'s03',name:'–õ–∏–¥—ã –ï–°–õ.–§–∏–∫—Å—Ü–µ–Ω–∞',catId:'ic1',moneyType:'income',active:true},{id:'s04',name:'–ò–ò.–û–ö–ö. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ',catId:'ic2',moneyType:'income',active:true},
  {id:'s05',name:'–ò–ò.–û–ö–ö. –ê–±–æ–Ω–µ–Ω—Ç–∫–∞',catId:'ic2',moneyType:'income',active:true},{id:'s06',name:'–ò–ò-–ö–¶. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ',catId:'ic2',moneyType:'income',active:true},
  {id:'s07',name:'–ò–ò.–ù–µ–π—Ä–æ–ø—Ä–æ–¥–∞–≤–µ—Ü',catId:'ic2',moneyType:'income',active:true},{id:'s08',name:'–ò–ò-–ö–¶. –ê–±–æ–Ω–µ–Ω—Ç–∫–∞',catId:'ic2',moneyType:'income',active:true},
  {id:'s09',name:'–ê–≥–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏',catId:'ic3',moneyType:'income',active:true},{id:'s10',name:'–ö–µ—à–±–µ–∫',catId:'ic4',moneyType:'income',active:true},
  {id:'s11',name:'–î—Ä—É–≥–æ–µ',catId:'ic5',moneyType:'income',active:true},{id:'s12',name:'–†–µ–∫–ª–∞–º–Ω—ã–µ –±—é–¥–∂–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤',catId:null,moneyType:'transit',active:true}
];
const SEED_EXP_CATS=[{id:'ec1',name:'–§–û–¢',desc:'–¢—Ä—É–¥ –∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–∏',active:true},{id:'ec2',name:'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥',desc:'–†–µ–∫–ª–∞–º–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',active:true},{id:'ec3',name:'–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞',desc:'–°–µ—Ä–≤–∏—Å—ã, —Å–≤—è–∑—å, –±—É—Ö.',active:true},{id:'ec4',name:'–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã',desc:'–ù–∞–ª–æ–≥–∏, –±–∞–Ω–∫',active:true},{id:'ec5',name:'–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç',desc:'R&D',active:true},{id:'ec6',name:'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ',desc:'–û–±—É—á–µ–Ω–∏–µ, –Ω–∞–π–º',active:true},{id:'ec7',name:'–ü—Ä–æ—á–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ',desc:'–§–æ–Ω–¥—ã, —à—Ç—Ä–∞—Ñ—ã',active:true}];
const SEED_EXP_TYPES=[
  {id:'et01',name:'–ù–∞—à –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∑.–ø. –∏—Å–ø–æ–ª–Ω.',catId:'ec1',active:true},{id:'et02',name:'–ü–æ–¥—Ä—è–¥—á–∏–∫–∏ –§–∏–∫—Å—Ü–µ–Ω–∞',catId:'ec1',active:true},
  {id:'et03',name:'–ü–æ–¥—Ä—è–¥—á–∏–∫–∏ –ª–∏–¥—ã –ö–¶',catId:'ec1',active:true},{id:'et04',name:'–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥',catId:'ec1',active:true},
  {id:'et05',name:'–†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞—à',catId:'ec2',active:true},{id:'et06',name:'–°–µ—Ä–≤–∏—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞',catId:'ec3',active:true},
  {id:'et07',name:'–°–µ—Ä–≤–∏—Å—ã –¥—Ä—É–≥–∏–µ',catId:'ec3',active:true},{id:'et08',name:'–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ',catId:'ec3',active:true},
  {id:'et09',name:'–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ',catId:'ec4',active:true},{id:'et10',name:'–ù–∞–ª–æ–≥–∏',catId:'ec4',active:true},
  {id:'et11',name:'–ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (—Ä–∞–∑–≤–∏—Ç–∏–µ)',catId:'ec5',active:true},{id:'et12',name:'–û–±—É—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤',catId:'ec6',active:true},
  {id:'et13',name:'–ù–∞–π–º –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è',catId:'ec6',active:true},{id:'et14',name:'–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ–Ω–¥',catId:'ec7',active:true},
  {id:'et15',name:'–†–µ–∑–µ—Ä–≤–Ω—ã–π —Ñ–æ–Ω–¥',catId:'ec7',active:true},{id:'et16',name:'–í–æ–∑–≤—Ä–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º',catId:'ec7',active:true},
  {id:'et17',name:'–í—ã–ø–ª–∞—Ç—ã –∞–≥–µ–Ω—Ç–∞–º',catId:'ec7',active:true},{id:'et18',name:'–ö–æ—Å—è–∫–∏',catId:'ec7',active:true}
];

// Account categories (fixed, v1)
const SEED_ACCT_CATS=[
  {id:'ac1',name:'–†–∞—Å—á—ë—Ç–Ω—ã–µ —Å—á–µ—Ç–∞',icon:'üè¶',defLiquidity:'high',defAffectsCash:true,side:'asset'},
  {id:'ac2',name:'–ö–∞—Ä—Ç—ã',icon:'üí≥',defLiquidity:'high',defAffectsCash:true,side:'asset'},
  {id:'ac3',name:'–†–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–±–∏–Ω–µ—Ç—ã',icon:'üì£',defLiquidity:'medium',defAffectsCash:false,side:'asset'},
  {id:'ac4',name:'–ë–∞–ª–∞–Ω—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤',icon:'‚öôÔ∏è',defLiquidity:'medium',defAffectsCash:false,side:'asset'},
  {id:'ac5',name:'–§–æ–Ω–¥—ã –∏ —Ä–µ–∑–µ—Ä–≤—ã',icon:'üõ°Ô∏è',defLiquidity:'low',defAffectsCash:false,side:'asset'},
  {id:'ac6',name:'–î–µ–±–∏—Ç–æ—Ä–∫–∞',icon:'üìÑ',defLiquidity:'low',defAffectsCash:false,side:'asset'},
  {id:'ac7',name:'–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ / –¥–æ–ª–≥–∏',icon:'‚ö†Ô∏è',defLiquidity:'low',defAffectsCash:false,side:'liability'}
];
const LIQ_LABELS={high:'–í—ã—Å–æ–∫–∞—è',medium:'–°—Ä–µ–¥–Ω—è—è',low:'–ù–∏–∑–∫–∞—è'};

// ========== STATE ==========
let DB={ops:[],bal:0},REF={incCats:[],svcs:[],expCats:[],expTypes:[]},cpMap={},rules=[],pending=[];
let FP={assets:[],liabilities:[],openBal:[],clientObl:[],obligations:[],accounts:[]}; // Financial Position data
let period='month',screen='dash',curMonth=new Date();
curMonth.setDate(1);

// ========== PERSISTENCE ==========
// ========== API MODULE ==========
const API_BASE = window.location.origin;
let AUTH_TOKEN = sessionStorage.getItem('ft5_token') || null;
let CURRENT_USER = null;
let DEMO_MODE = false;
let _saveTimer = null;
const SAVE_DEBOUNCE = 800; // ms

async function api(method, path, body) {
  if (DEMO_MODE) throw new Error('Demo mode ‚Äî no API');
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (AUTH_TOKEN) opts.headers['Authorization'] = 'Bearer ' + AUTH_TOKEN;
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API_BASE + path, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'API error');
  return data;
}

function setToken(token) { AUTH_TOKEN = token; sessionStorage.setItem('ft5_token', token); }
function clearToken() { AUTH_TOKEN = null; sessionStorage.removeItem('ft5_token'); }

// ========== AUTH UI ==========
let authMode = 'login'; // login | register

function toggleAuthMode() {
  authMode = authMode === 'login' ? 'register' : 'login';
  $('authNameWrap').style.display = authMode === 'register' ? '' : 'none';
  $('authBtn').textContent = authMode === 'login' ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
  $('authSub').textContent = authMode === 'login' ? '–í–æ–π–¥–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è' : '–°–æ–∑–¥–∞–π –∞–∫–∫–∞—É–Ω—Ç';
  $('authSwitch').innerHTML = authMode === 'login' 
    ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleAuthMode()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>'
    : '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="toggleAuthMode()">–í–æ–π—Ç–∏</a>';
  $('authErr').textContent = '';
}

async function doAuth() {
  const email = $('authEmail').value.trim();
  const pass = $('authPass').value;
  const name = $('authName').value.trim();
  if (!email || !pass) { $('authErr').textContent = '–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å'; return; }
  $('authBtn').disabled = true;
  $('authErr').textContent = '';
  try {
    const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
    const body = authMode === 'login' ? { email, password: pass } : { email, password: pass, name };
    const data = await api('POST', endpoint, body);
    setToken(data.token);
    CURRENT_USER = data.user;
    await bootApp();
  } catch (e) {
    $('authErr').textContent = e.message;
  } finally {
    $('authBtn').disabled = false;
  }
}

function showUserMenu() {
  if (!CURRENT_USER) return;
  const demoNote = DEMO_MODE ? '<div style="font-size:10px;color:var(--yl);margin-bottom:10px;padding:6px 10px;background:rgba(250,204,21,.1);border-radius:8px">üöÄ –î–µ–º–æ-—Ä–µ–∂–∏–º ¬∑ –¥–∞–Ω–Ω—ã–µ –≤ localStorage</div>' : '';
  showModal(`<h3>üë§ ${esc(CURRENT_USER.name || CURRENT_USER.email)}</h3>
    ${demoNote}
    <div style="font-size:11px;color:var(--tx2);margin-bottom:14px">
      <div>Email: ${esc(CURRENT_USER.email)}</div>
      <div>–†–æ–ª—å: <strong>${CURRENT_USER.role === 'owner' ? 'üëë Owner' : 'üß™ Tester'}</strong></div>
    </div>
    ${!DEMO_MODE && CURRENT_USER.role === 'owner' ? '<button class="btn btn-o" style="margin-bottom:8px;width:100%" onclick="closeModal();showAdminPanel()">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>' : ''}
    <div class="btn-grp">
      <button class="btn btn-d" onclick="doLogout()">–í—ã–π—Ç–∏</button>
      <button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>`);
}

function doLogout() {
  clearToken(); CURRENT_USER = null; DEMO_MODE = false;
  $('authScreen').classList.remove('hidden');
  $('appWrap').style.display = 'none';
  closeModal();
}

async function startDemo() {
  DEMO_MODE = true;
  CURRENT_USER = { id: 0, email: 'demo@fintablo.local', name: '–î–µ–º–æ', role: 'owner' };
  await bootApp();
}

async function showAdminPanel() {
  try {
    const { users } = await api('GET', '/api/admin/users');
    let rows = users.map(u => `<tr>
      <td>${esc(u.name || '‚Äî')}</td><td>${esc(u.email)}</td>
      <td><span class="tag ${u.role === 'owner' ? 'tag-in' : 'tag-off'}">${u.role}</span></td>
      <td>${u.id !== CURRENT_USER.id ? `<button class="btn btn-d" style="padding:2px 6px;font-size:9px" onclick="deleteUser(${u.id})">‚úï</button>` : '<span style="font-size:9px;color:var(--mt)">—Ç—ã</span>'}</td>
    </tr>`).join('');
    showModal(`<h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <table class="ctbl"><thead><tr><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th><th></th></tr></thead><tbody>${rows}</tbody></table>
      <div style="margin-top:14px"><div class="slbl" style="font-size:11px">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–µ—Ä–∞</div>
        <div class="form-row">
          <div class="form-g"><input id="_auEmail" placeholder="email"></div>
          <div class="form-g"><input id="_auPass" placeholder="–ø–∞—Ä–æ–ª—å"></div>
          <div class="form-g"><input id="_auName" placeholder="–∏–º—è"></div>
        </div>
        <button class="btn btn-p" style="margin-top:6px" onclick="addTester()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="btn-grp" style="margin-top:14px"><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
  } catch (e) { toast(e.message, 'err'); }
}

async function addTester() {
  try {
    await api('POST', '/api/admin/users', { email: $('_auEmail').value, password: $('_auPass').value, name: $('_auName').value, role: 'tester' });
    toast('–¢–µ—Å—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
    showAdminPanel();
  } catch (e) { toast(e.message, 'err'); }
}

async function deleteUser(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
  try { await api('DELETE', '/api/admin/users/' + id); toast('–£–¥–∞–ª—ë–Ω'); showAdminPanel(); } catch (e) { toast(e.message, 'err'); }
}

// ========== DATA SAVE / LOAD (API) ==========
function save() {
  if (DEMO_MODE) {
    try { localStorage.setItem('ft5_demo', JSON.stringify({ DB, REF, cpMap, rules, FP })); } catch(e) {}
    return;
  }
  // Debounced save to API
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async () => {
    try {
      await api('PUT', '/api/data', { data: { DB, REF, cpMap, rules, FP } });
    } catch (e) {
      console.error('Save failed:', e);
      toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'err');
    }
  }, SAVE_DEBOUNCE);
}

async function loadFromServer() {
  let data;
  if (DEMO_MODE) {
    try { data = JSON.parse(localStorage.getItem('ft5_demo') || '{}'); } catch(e) { data = {}; }
  } else {
    const resp = await api('GET', '/api/data');
    data = resp.data || {};
  }
  DB = data.DB || { ops: [], bal: 0 };
  REF = data.REF || { incCats: [], svcs: [], expCats: [], expTypes: [] };
  cpMap = data.cpMap || {};
  rules = data.rules || [];
  FP = data.FP || { assets: [], liabilities: [], openBal: [], clientObl: [], obligations: [], accounts: [] };
  if (!FP.openBal) FP.openBal = [];
  if (!FP.clientObl) FP.clientObl = [];
  if (!FP.accounts) FP.accounts = [];
  if (!FP.obligations) FP.obligations = [];
  migrateObligations();
}

function load() {
  // Legacy stub ‚Äî actual load is async via bootApp
  DB = { ops: [], bal: 0 };
  REF = { incCats: [], svcs: [], expCats: [], expTypes: [] };
  cpMap = {};
  rules = [];
  FP = { assets: [], liabilities: [], openBal: [], clientObl: [], obligations: [], accounts: [] };
}
function initRefs(){
  const cl=o=>JSON.parse(JSON.stringify(o));
  if(!REF.incCats?.length)REF.incCats=cl(SEED_INC_CATS);if(!REF.svcs?.length)REF.svcs=cl(SEED_SVCS);
  if(!REF.expCats?.length)REF.expCats=cl(SEED_EXP_CATS);if(!REF.expTypes?.length)REF.expTypes=cl(SEED_EXP_TYPES);
  if(!rules.length)rules=[
    {p:'–∑–∞—Ä–ø–ª–∞—Ç|–∑\\/–ø|\\b–∑–ø\\b|–æ–∫–ª–∞–¥',c:'et01',d:'out'},
    {p:'–ø–æ–¥—Ä—è–¥—á–∏–∫|—Å—É–±–ø–æ–¥—Ä—è–¥|—Ñ—Ä–∏–ª–∞–Ω—Å',c:'et04',d:'out'},
    {p:'—è–Ω–¥–µ–∫—Å\\.–¥–∏—Ä–µ–∫—Ç|google ads|vk ads',c:'et05',d:'out'},
    {p:'planfix|whatsapp|wazzup|–±–∏—Ç—Ä–∏–∫—Å|amo|openai|saas|–ø–æ–¥–ø–∏—Å–∫–∞',c:'et06',d:'out'},
    {p:'–±—É—Ö–≥–∞–ª—Ç–µ—Ä',c:'et08',d:'out'},
    {p:'–∫–æ–º–∏—Å—Å–∏.*–±–∞–Ω–∫|—ç–∫–≤–∞–π—Ä–∏–Ω–≥|—Ä–∫–æ|–ø–∞–∫–µ—Ç.*—É—Å–ª—É–≥|–ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω.*–≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥',c:'et09',d:'out'},
    {p:'–Ω–∞–ª–æ–≥|–Ω–¥—Å|—É—Å–Ω|–Ω–¥—Ñ–ª|—Å—Ç—Ä–∞—Ö–æ–≤.*–≤–∑–Ω–æ—Å',c:'et10',d:'out'},
    {p:'–≤–æ–∑–≤—Ä–∞—Ç.*–∫–ª–∏–µ–Ω—Ç',c:'et16',d:'out'},
    {p:'–¥–∏–≤–∏–¥–µ–Ω–¥|–≤—ã–ø–ª–∞—Ç–∞.*—Å–æ–±—Å—Ç–≤–µ–Ω',c:'_owner',d:'out'},
    {p:'–ø–µ—Ä–µ–≤–æ–¥.*–º–µ–∂–¥—É.*—Å—á–µ—Ç|—Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥.*—Ñ–æ–Ω–¥',c:'_internal',d:'out'},
    {p:'–∑–∞—è–≤–∫.*—è–Ω–¥–µ–∫—Å|–ª–∏–¥.*–∫—Ü',c:'s01',d:'in'},
    {p:'—Ä–µ–∫–ª–∞–º–Ω.*–±—é–¥–∂–µ—Ç.*–∫–ª–∏–µ–Ω—Ç|–±—é–¥–∂–µ—Ç.*–≤–∏—Ç–∞–º–∏–Ω|–∫–∞–±–∏–Ω–µ—Ç',c:'s12',d:'in'},
    {p:'–∫–µ—à–±–µ–∫|cashback',c:'s10',d:'in'},
    {p:'–∞–≥–µ–Ω—Ç—Å–∫|–∫–æ–º–∏—Å—Å–∏.*–ø–∞—Ä—Ç–Ω',c:'s09',d:'in'},
  ];
}

// ========== HELPERS ==========
function fmt(n){if(n==null)return'‚Äî';const a=Math.abs(n);if(a>=1e6)return(n/1e6).toFixed(2)+'–ú';return Math.round(n).toLocaleString('ru-RU')}
function fR(n){return fmt(n)+' ‚ÇΩ'}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;')}
function $(id){return document.getElementById(id)}
function toast(m,t='ok'){const el=$('toast');el.textContent=m;el.className='toast '+t+' show';setTimeout(()=>el.classList.remove('show'),3200)}
function uid(){return'_'+Math.random().toString(36).slice(2,8)}
function nm(arr,id){const x=arr.find(i=>i.id===id);return x?x.name:'?'}
const OT={in:{icon:'‚Üì',color:'var(--gr)',lbl:'üì• –î–æ—Ö–æ–¥'},out:{icon:'‚Üë',color:'var(--rd)',lbl:'üì§ –†–∞—Å—Ö–æ–¥'},transit:{icon:'‚ü≥',color:'var(--tr)',lbl:'üîÑ –¢—Ä–∞–Ω–∑–∏—Ç'},owner:{icon:'üí∏',color:'var(--ow)',lbl:'üí∏ –î–∏–≤–∏–¥–µ–Ω–¥—ã'},internal:{icon:'‚Üî',color:'var(--it)',lbl:'‚ÜîÔ∏è –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π'}};
function opLabel(o){if(o.t==='owner')return'–î–∏–≤–∏–¥–µ–Ω–¥—ã';if(o.t==='internal')return'–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥';if(o.t==='in'||o.t==='transit')return o.svcId?nm(REF.svcs,o.svcId):'‚Äî';return o.expTypeId?nm(REF.expTypes,o.expTypeId):'‚Äî'}
function goTab(s){document.querySelectorAll('.nav-t').forEach(x=>x.classList.remove('on'));document.querySelectorAll('.scr').forEach(x=>x.classList.remove('on'));document.querySelector(`[data-s="${s}"]`).classList.add('on');$('s-'+s).classList.add('on');screen=s;$('pbar').style.display=['dash','exp','inc'].includes(s)?'flex':'none';if(s==='fp')renderFP();if(s==='acct')renderAccounts();if(s==='imp')populateImpAcct()}

// ========== PERIOD ==========
const MN=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
function pRange(p){
  const now=new Date();let s,e;
  if(p==='month'){s=new Date(curMonth);e=new Date(s.getFullYear(),s.getMonth()+1,0)}
  else if(p==='quarter'){const q=Math.floor(curMonth.getMonth()/3);s=new Date(curMonth.getFullYear(),q*3,1);e=new Date(curMonth.getFullYear(),q*3+3,0)}
  else if(p==='week'){s=new Date(now);const d=s.getDay()||7;s.setDate(s.getDate()-d+1);e=new Date(s);e.setDate(e.getDate()+6)}
  else{s=new Date('2020-01-01');e=new Date('2030-12-31')}
  return{s:ds(s),e:ds(e)}
}
function prevRange(){const pm=new Date(curMonth);pm.setMonth(pm.getMonth()-1);const s=new Date(pm),e=new Date(pm.getFullYear(),pm.getMonth()+1,0);return{s:ds(s),e:ds(e)}}
function ds(d){return d.toISOString().slice(0,10)}
function opsInR(s,e){return DB.ops.filter(o=>o.d>=s&&o.d<=e)}
function opsIn(p){const{s,e}=pRange(p);return opsInR(s,e)}
function opsBefore(d){return DB.ops.filter(o=>o.d<d)}
function shiftMonth(d){if(period==='quarter'){curMonth.setMonth(curMonth.getMonth()+(d*3))}else{curMonth.setMonth(curMonth.getMonth()+d)}renderPeriod();renderAll()}
function renderPeriod(){const QN=['Q1','Q2','Q3','Q4'];if(period==='quarter'){const q=Math.floor(curMonth.getMonth()/3);$('mnLabel').textContent=QN[q]+' '+curMonth.getFullYear()}else{$('mnLabel').textContent=MN[curMonth.getMonth()]+' '+curMonth.getFullYear()}const{s,e}=pRange(period);$('pInfo').textContent=`${s} ‚Äî ${e}`;$('monthNav').style.display=['month','quarter'].includes(period)?'flex':'none'}

// ========== CALCULATIONS ==========
function delta(o){if(o.t==='in'||o.t==='transit')return o.a;if(o.t==='out'||o.t==='owner')return-Math.abs(o.a);return 0}
function calcCF(p){
  const{s,e}=pRange(p);const ops=opsIn(p);
  const prior=opsBefore(s).reduce((a,o)=>a+delta(o),0);const opening=getOpenBal()+prior;
  const income=ops.filter(o=>o.t==='in').reduce((a,o)=>a+o.a,0);
  const transit=ops.filter(o=>o.t==='transit').reduce((a,o)=>a+o.a,0);
  const expense=ops.filter(o=>o.t==='out').reduce((a,o)=>a+Math.abs(o.a),0);
  const ownerW=ops.filter(o=>o.t==='owner').reduce((a,o)=>a+Math.abs(o.a),0);
  const net=income+transit-expense-ownerW;
  return{s,e,opening,income,transit,expense,ownerW,net,closing:opening+net}
}
function calcPrev(){
  if(period!=='month')return null;
  const{s,e}=prevRange();const ops=opsInR(s,e);
  return{income:ops.filter(o=>o.t==='in').reduce((a,o)=>a+o.a,0),expense:ops.filter(o=>o.t==='out').reduce((a,o)=>a+Math.abs(o.a),0),ownerW:ops.filter(o=>o.t==='owner').reduce((a,o)=>a+Math.abs(o.a),0)}
}
function trend(cur,prev){if(!prev||prev===0)return'';const d=((cur-prev)/Math.abs(prev)*100);if(Math.abs(d)<1)return'<span class="flat">‚Äî</span>';return d>0?`<span class="up">‚ñ≤ ${Math.abs(d).toFixed(0)}%</span>`:`<span class="dn">‚ñº ${Math.abs(d).toFixed(0)}%</span>`}

function grpBy(p,flowType,fn){
  const ops=opsIn(p).filter(o=>o.t===flowType);
  const m={};ops.forEach(o=>{const k=fn(o);m[k]=(m[k]||0)+Math.abs(o.a)});
  const tot=Object.values(m).reduce((a,v)=>a+v,0)||1;
  return Object.entries(m).map(([k,a])=>({k,a,p:+(a/tot*100).toFixed(1)})).sort((a,b)=>b.a-a.a)
}
// Drill-down: items under a category
function drillItems(p,flowType,catKey,catFn,itemFn){
  const ops=opsIn(p).filter(o=>o.t===flowType&&catFn(o)===catKey);
  const m={};ops.forEach(o=>{const k=itemFn(o);m[k]=(m[k]||0)+Math.abs(o.a)});
  return Object.entries(m).map(([k,a])=>({k,a})).sort((a,b)=>b.a-a.a)
}

// ========== CLOSED WEEK CALCULATION ==========
function closedWeek(){
  // Last fully closed Mon-Sun before today
  const now=new Date();const dow=now.getDay()||7; // 1=Mon..7=Sun
  // Last Monday = today minus (dow-1) days. Previous Monday = that minus 7.
  const thisMon=new Date(now);thisMon.setDate(now.getDate()-(dow-1));
  const prevMon=new Date(thisMon);prevMon.setDate(thisMon.getDate()-7);
  const prevSun=new Date(thisMon);prevSun.setDate(thisMon.getDate()-1);
  return{s:ds(prevMon),e:ds(prevSun)}
}
function prevClosedWeek(){
  const cw=closedWeek();
  const s=new Date(cw.s);s.setDate(s.getDate()-7);
  const e=new Date(cw.s);e.setDate(e.getDate()-1);
  return{s:ds(s),e:ds(e)}
}

// ========== RENDER: OWNER DASHBOARD ==========
function renderDash(){
  const cf=calcCF(period); // month-level
  const cw=closedWeek(), pw=prevClosedWeek();
  const cwOps=opsInR(cw.s,cw.e), pwOps=opsInR(pw.s,pw.e);

  // Context label
  $('odCtx').innerHTML=`–ú–µ—Å—è—Ü: <b>${MN[curMonth.getMonth()]} ${curMonth.getFullYear()}</b> &nbsp;¬∑&nbsp; –ù–µ–¥–µ–ª—è: <b>${cw.s} ‚Äî ${cw.e}</b>`;

  // === 1. KPI STRIP (month) ===
  const net=cf.income-cf.expense; // —á–∏—Å—Ç—ã–π –ø–æ—Ç–æ–∫ –±–µ–∑ —Ç—Ä–∞–Ω–∑–∏—Ç–∞ –∏ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ –¥–ª—è cash flow
  $('odKpi').innerHTML=`
    <div class="od-kpi"><div class="k-label">–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞—á–∞–ª–æ</div><div class="k-val">${fR(cf.opening)}</div></div>
    <div class="od-kpi"><div class="k-label">–î–æ—Ö–æ–¥—ã</div><div class="k-val pos">+${fR(cf.income)}</div></div>
    <div class="od-kpi"><div class="k-label">–†–∞—Å—Ö–æ–¥—ã</div><div class="k-val neg">‚àí${fR(cf.expense)}</div></div>
    <div class="od-kpi hero"><div class="k-label">–ß–∏—Å—Ç—ã–π –ø–æ—Ç–æ–∫</div><div class="k-val ${cf.net>=0?'pos':'neg'}">${cf.net>=0?'+':''}${fR(cf.net)}</div>${cf.transit?`<div class="k-sub">—Ç—Ä–∞–Ω–∑–∏—Ç +${fR(cf.transit)} ¬∑ –¥–∏–≤–∏–¥–µ–Ω–¥—ã ‚àí${fR(cf.ownerW)}</div>`:cf.ownerW?`<div class="k-sub">–¥–∏–≤–∏–¥–µ–Ω–¥—ã ‚àí${fR(cf.ownerW)}</div>`:''}</div>
    <div class="od-kpi"><div class="k-label">–û—Å—Ç–∞—Ç–æ–∫ –∫–æ–Ω–µ—Ü</div><div class="k-val">${fR(cf.closing)}</div></div>`;

  // === 2. INCOME STRUCTURE (week, 3 categories) ===
  const incCatIds=['ic1','ic2','ic3']; // –æ—Å–Ω–æ–≤–Ω–∞—è, –¥–æ–ø, —Ä–∞–∑–æ–≤—ã–µ
  const incCards=incCatIds.map(catId=>{
    const cat=REF.incCats.find(c=>c.id===catId);
    const cwAmt=cwOps.filter(o=>o.t==='in'&&svcCatId(o.svcId)===catId).reduce((a,o)=>a+o.a,0);
    const pwAmt=pwOps.filter(o=>o.t==='in'&&svcCatId(o.svcId)===catId).reduce((a,o)=>a+o.a,0);
    const cwTotal=cwOps.filter(o=>o.t==='in').reduce((a,o)=>a+o.a,0)||1;
    const pct=((cwAmt/cwTotal)*100).toFixed(0);
    return{name:cat?.name||'?',cwAmt,pwAmt,pct}
  });
  $('odInc').innerHTML=incCards.map(c=>`<div class="od-inc-card"><div class="ic-name">${esc(c.name)}</div><div class="ic-val pos">+${fR(c.cwAmt)}</div><div class="ic-trend">${trend(c.cwAmt,c.pwAmt)}<span style="color:var(--mt);margin-left:4px">vs –ø—Ä. –Ω–µ–¥.</span></div><div class="ic-pct">${c.pct}% –æ—Ç –¥–æ—Ö–æ–¥–∞ –Ω–µ–¥–µ–ª–∏</div></div>`).join('');

  // === 3. EXPENSE TOP-5 (week) ===
  const expByCat={};
  cwOps.filter(o=>o.t==='out').forEach(o=>{
    const catName=expTypeToCat(o.expTypeId);
    expByCat[catName]=(expByCat[catName]||0)+Math.abs(o.a)
  });
  const expTotal=Object.values(expByCat).reduce((a,v)=>a+v,0)||1;
  const top5=Object.entries(expByCat).map(([k,a])=>({k,a,pct:+(a/expTotal*100).toFixed(1)})).sort((a,b)=>b.a-a.a).slice(0,5);
  const maxExp=top5[0]?.a||1;
  const colors=['var(--rd)','var(--or)','var(--yl)','var(--bl)','var(--ac)'];
  $('odExp').innerHTML=top5.length?top5.map((it,i)=>`<div class="od-exp-row"><div class="e-name">${esc(it.k)}</div><div class="e-bar"><div class="e-fill" style="width:${(it.a/maxExp*100).toFixed(0)}%;background:${colors[i]}"></div></div><div class="e-val"><span class="mono neg">‚àí${fR(it.a)}</span><div class="e-pct">${it.pct}%</div></div></div>`).join(''):'<div style="color:var(--mt);font-size:12px">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</div>';

  // === 4. ANOMALIES ===
  const anomalies=calcAnomalies(cwOps,pwOps);
  const anoEl=$('odAno'),anoSec=$('odAnoSec');
  if(anomalies.length){
    anoSec.style.display='';
    anoEl.innerHTML=anomalies.map(a=>`<div class="od-anomaly"><span class="a-icon">‚ö†Ô∏è</span><span>${a}</span></div>`).join('')
  } else {
    anoSec.style.display='';
    anoEl.innerHTML='<div class="od-anomaly ok"><span class="a-icon">‚úÖ</span><span>–ê–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</span></div>'
  }

  // === 5. AUTO SUMMARY ===
  $('odSum').innerHTML=generateSummary(cf,cwOps,pwOps,anomalies,cw);

  // === 6. REAL POSITION INDICATOR ===
  renderDashPosition()
}

function renderDashPosition(){
  const el=$('odPos');if(!el)return;
  const fp=calcFP();
  if(!fp.hasData){el.innerHTML='<div class="od-pos-card" onclick="goTab(\'fp\')"><div style="color:var(--mt);font-size:12px;text-align:center;padding:8px 0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∑–∏—Ü–∏–∏. <span style="color:var(--ac);cursor:pointer">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å ‚Üí</span></div></div>';return}

  const net=fp.realPosition;
  let icon,cls;
  if(net>0&&fp.liabRatio<0.5){icon='üü¢';cls='pos'}
  else if(net>=0){icon='üü°';cls=''}
  else{icon='üî¥';cls='neg'}

  el.innerHTML=`<div class="od-pos-card" onclick="goTab('fp')">
    <div class="od-pos-row">
      <div class="od-pos-main"><div class="od-pos-label">${icon} –†–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è</div><div class="od-pos-val mono ${cls}">${net>=0?'+':''}${fR(net)}</div></div>
      <div class="od-pos-item"><div class="p-lbl">–õ–∏–∫–≤–∏–¥–Ω—ã–µ</div><div class="p-val mono pos">${fR(fp.totalLiquid)}</div></div>
      <div class="od-pos-item"><div class="p-lbl">–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</div><div class="p-val mono neg">${fR(fp.totalLiab)}</div></div>
      <div class="od-pos-item">${fp.totalRecv>0?`<div class="p-lbl">–î–µ–±–∏—Ç–æ—Ä–∫–∞ ‚ìò</div><div class="p-val mono" style="color:var(--yl)">${fR(fp.totalRecv)}</div>`:`<div class="p-lbl">–î–µ–±–∏—Ç–æ—Ä–∫–∞</div><div class="p-val mono" style="color:var(--mt)">‚Äî</div>`}</div>
    </div>
    <div class="od-pos-go">–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç ‚Üí</div>
  </div>`
}

// Helper: get income category id from service id
function svcCatId(svcId){if(!svcId)return null;const s=REF.svcs.find(x=>x.id===svcId);return s?.catId||null}
// Helper: get expense category name from expTypeId
function expTypeToCat(etId){if(!etId)return'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';const et=REF.expTypes.find(t=>t.id===etId);if(!et?.catId)return'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';return nm(REF.expCats,et.catId)}

// ========== ANOMALY DETECTION ==========
function calcAnomalies(cwOps,pwOps){
  const a=[];

  // Rule 1: expense category growth > 30%
  const cwExpByCat={},pwExpByCat={};
  cwOps.filter(o=>o.t==='out').forEach(o=>{const c=expTypeToCat(o.expTypeId);cwExpByCat[c]=(cwExpByCat[c]||0)+Math.abs(o.a)});
  pwOps.filter(o=>o.t==='out').forEach(o=>{const c=expTypeToCat(o.expTypeId);pwExpByCat[c]=(pwExpByCat[c]||0)+Math.abs(o.a)});
  for(const[cat,amt]of Object.entries(cwExpByCat)){
    const prev=pwExpByCat[cat]||0;
    if(prev>0){const growth=((amt-prev)/prev)*100;if(growth>30)a.push(`<b>${esc(cat)}</b> –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ <b>${growth.toFixed(0)}%</b> vs –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è (${fR(prev)} ‚Üí ${fR(amt)})`)}
    else if(amt>5000)a.push(`<b>${esc(cat)}</b> ‚Äî –Ω–æ–≤–∞—è —Å—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–∞: <b>${fR(amt)}</b>`)
  }

  // Rule 2: –†–∞–∑–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ (ic3) > 30% –¥–æ—Ö–æ–¥–∞
  const cwIncome=cwOps.filter(o=>o.t==='in').reduce((s,o)=>s+o.a,0);
  const cwIc3=cwOps.filter(o=>o.t==='in'&&svcCatId(o.svcId)==='ic3').reduce((s,o)=>s+o.a,0);
  if(cwIncome>0&&cwIc3/cwIncome>0.3)a.push(`–†–∞–∑–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ = <b>${(cwIc3/cwIncome*100).toFixed(0)}%</b> –æ—Ç –¥–æ—Ö–æ–¥–∞ –Ω–µ–¥–µ–ª–∏. –í—ã—Å–æ–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.`);

  // Rule 3: –ü—Ä–æ—á–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ (ec7) > 10% —Ä–∞—Å—Ö–æ–¥–æ–≤
  const cwExpense=cwOps.filter(o=>o.t==='out').reduce((s,o)=>s+Math.abs(o.a),0);
  const cwEc7=cwOps.filter(o=>o.t==='out'&&expTypeToCat(o.expTypeId)==='–ü—Ä–æ—á–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ').reduce((s,o)=>s+Math.abs(o.a),0);
  if(cwExpense>0&&cwEc7/cwExpense>0.1)a.push(`–ü—Ä–æ—á–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ = <b>${(cwEc7/cwExpense*100).toFixed(0)}%</b> —Ä–∞—Å—Ö–æ–¥–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–∑–Ω–µ—Å—Ç–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.`);

  return a
}

// ========== AUTO SUMMARY ==========
function generateSummary(cf,cwOps,pwOps,anomalies,cw){
  const cwInc=cwOps.filter(o=>o.t==='in').reduce((s,o)=>s+o.a,0);
  const cwExp=cwOps.filter(o=>o.t==='out').reduce((s,o)=>s+Math.abs(o.a),0);
  const weekNet=cwInc-cwExp;
  const pwInc=pwOps.filter(o=>o.t==='in').reduce((s,o)=>s+o.a,0);
  const pwExp=pwOps.filter(o=>o.t==='out').reduce((s,o)=>s+Math.abs(o.a),0);

  let s='';
  if(!cwOps.length)return'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–∫—Ä—ã—Ç—É—é –Ω–µ–¥–µ–ª—é. –ó–∞–≥—Ä—É–∑–∏ –≤—ã–ø–∏—Å–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.';

  // Week result
  if(weekNet>=0)s+=`–ù–µ–¥–µ–ª—è <b>${cw.s}‚Äî${cw.e}</b> –≤ –ø–ª—é—Å–µ: –¥–æ—Ö–æ–¥ <b class="pos">${fR(cwInc)}</b>, —Ä–∞—Å—Ö–æ–¥ <b class="neg">${fR(cwExp)}</b>, —á–∏—Å—Ç—ã–π <b class="pos">+${fR(weekNet)}</b>.`;
  else s+=`–ù–µ–¥–µ–ª—è <b>${cw.s}‚Äî${cw.e}</b> –≤ –º–∏–Ω—É—Å–µ: –¥–æ—Ö–æ–¥ <b>${fR(cwInc)}</b>, —Ä–∞—Å—Ö–æ–¥ <b class="neg">${fR(cwExp)}</b>, –¥–µ—Ñ–∏—Ü–∏—Ç <b class="neg">${fR(Math.abs(weekNet))}</b>.`;

  // Month context
  const monthPct=cf.income>0?((cwInc/cf.income)*100).toFixed(0):'‚Äî';
  s+=` –î–æ—Ö–æ–¥ –Ω–µ–¥–µ–ª–∏ ‚Äî <b>${monthPct}%</b> –æ—Ç –º–µ—Å—è—á–Ω–æ–≥–æ.`;

  // Anomaly hint
  if(anomalies.length)s+=` –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ <b>${anomalies.length}</b> –∞–Ω–æ–º–∞–ª–∏${anomalies.length===1?'—è':'–∏'} ‚Äî —Å–º. –≤—ã—à–µ.`;
  else s+=' –ê–Ω–æ–º–∞–ª–∏–π –Ω–µ—Ç.';

  return s
}

// ========== RENDER: DRILL-DOWN LISTS ==========
let expanded={};
function catFnExp(o){if(o.expTypeId){const et=REF.expTypes.find(t=>t.id===o.expTypeId);if(et?.catId)return nm(REF.expCats,et.catId)}return'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
function catFnInc(o){if(o.svcId){const s=REF.svcs.find(x=>x.id===o.svcId);if(s?.catId)return nm(REF.incCats,s.catId)}return'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}

function renderDrill(elId,items,ft,catFn,itemFn){
  const el=$(elId);
  if(!items.length){el.innerHTML=`<div class="empty"><div class="ei">üì≠</div><div class="et">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div><div class="ed">–ó–∞–≥—Ä—É–∑–∏ –≤—ã–ø–∏—Å–∫—É –∏ —Ä–∞–∑–º–µ—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏</div><div class="cta" onclick="goTab('imp')">‚Üí –ò–º–ø–æ—Ä—Ç –≤—ã–ø–∏—Å–∫–∏</div></div>`;return}
  el.innerHTML=items.map((it,i)=>{
    const key=elId+':'+it.k;const isExp=expanded[key];
    const drillHtml=isExp?renderDrillItems(drillItems(period,ft,it.k,catFn,itemFn),ft):'';
    return`<div class="drow${isExp?' expanded':''}" onclick="toggleDrill('${key}')"><div class="drow-l"><div class="dcat"><span class="chevron">‚ñ∏</span> ${esc(it.k)}</div><div class="dbar-t"><div class="dbar-f b${(ft==='out'?i:(i+4))%8}" style="width:${it.p}%"></div></div></div><div class="drow-r"><div class="damt mono ${ft==='out'?'neg':'pos'}">${ft==='out'?'‚àí':'+'}${fR(it.a)}</div><div class="dpct mono">${it.p}%</div></div></div>${isExp?`<div class="drill">${drillHtml}</div>`:''}`
  }).join('')
}
function renderDrillItems(items,ft){
  if(!items.length)return'<div style="font-size:11px;color:var(--mt);padding:4px 0">‚Äî</div>';
  return items.map(it=>`<div class="drill-item"><span>${esc(it.k)}</span><span class="mono ${ft==='out'?'neg':'pos'}" style="font-weight:600">${ft==='out'?'‚àí':'+'}${fR(it.a)}</span></div>`).join('')
}
function toggleDrill(key){expanded[key]=!expanded[key];renderExpense();renderIncome()}

function renderExpense(){renderDrill('expCatL',grpBy(period,'out',catFnExp),'out',catFnExp,o=>o.expTypeId?nm(REF.expTypes,o.expTypeId):'–ë–µ–∑ –≤–∏–¥–∞')}
function renderIncome(){renderDrill('incCatL',grpBy(period,'in',catFnInc),'in',catFnInc,o=>o.svcId?nm(REF.svcs,o.svcId):'–ë–µ–∑ —É—Å–ª—É–≥–∏')}
function renderCnt(){$('opCnt').textContent=DB.ops.length+' –æ–ø.'}
function renderAll(){renderDash();renderExpense();renderIncome();renderCnt();renderRecent();renderSavedMap();renderRules();renderRef();if(screen==='fp')renderFP();renderOpenBal()}

// ========== FINANCIAL POSITION REPORT ==========
const FP_ASSET_TYPES={account:'–°—á—ë—Ç',card:'–ö–∞—Ä—Ç–∞',service:'–°–µ—Ä–≤–∏—Å',reserve:'–†–µ–∑–µ—Ä–≤'};

// ===== UNIFIED OBLIGATIONS =====
// Type is auto-determined from two flags:
//   foreignMoney + !settled = client (—á—É–∂–∏–µ –¥–µ–Ω—å–≥–∏, –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã)
//   foreignMoney + settled  = transit (—á—É–∂–∏–µ, –≤ –¥–≤–∏–∂–µ–Ω–∏–∏/—Å–ø–∏—Å–∞–ª–∏—Å—å)
//   !foreignMoney + !settled = accrued (–Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ, –Ω–µ —Å–ø–∏—Å–∞–ª–∏—Å—å)
//   !foreignMoney + settled  = other (–ø—Ä–æ—á–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ª–≥–∏)
const OBL_TYPES={client:'–ü–µ—Ä–µ–¥ –∫–ª–∏–µ–Ω—Ç–∞–º–∏',transit:'–¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ',accrued:'–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ',other:'–ü—Ä–æ—á–∏–µ'};
const OBL_ICONS={client:'üë§',transit:'üîÑ',accrued:'üìã',other:'üìå'};
const OBL_ORDER=['client','transit','accrued','other'];
let oblFilter='all'; // 'all' | 'client' | 'transit' | 'accrued' | 'other'

function oblType(foreignMoney,settled){
  if(foreignMoney&&!settled)return'client';
  if(foreignMoney&&settled)return'transit';
  if(!foreignMoney&&!settled)return'accrued';
  return'other'
}

// Migrate legacy data: clientObl + liabilities ‚Üí obligations
function migrateObligations(){
  if(FP.obligations)return; // already migrated
  FP.obligations=[];
  // Migrate clientObl
  if(FP.clientObl&&FP.clientObl.length){
    FP.clientObl.forEach(c=>{
      FP.obligations.push({
        id:c.id||uid(),name:c.svcId?((REF.svcs.find(s=>s.id===c.svcId)||{}).name||c.svcId):'–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –æ–±—è–∑.',
        amount:c.amount,confidence:c.confidence||'exact',comment:c.comment||'',
        foreignMoney:true,settled:false,type:'client',
        svcId:c.svcId,active:c.active!==false,updatedAt:c.updatedAt||new Date().toISOString()
      })
    })
  }
  // Migrate liabilities
  if(FP.liabilities&&FP.liabilities.length){
    FP.liabilities.forEach(l=>{
      const fm=l.type==='client'||l.type==='transit';
      const st=l.type==='transit'||l.type==='other';
      FP.obligations.push({
        id:l.id||uid(),name:l.name,amount:l.amount,confidence:l.confidence||'exact',comment:l.comment||'',
        foreignMoney:fm,settled:st,type:l.type||'other',
        active:l.active!==false,updatedAt:l.updatedAt||new Date().toISOString()
      })
    })
  }
  // Keep old arrays for backup compat but mark migrated
  FP._migratedV6=true;
}

// Opening balance: sum of all active openBal entries, fallback to legacy DB.bal
function getOpenBal(){
  if(FP.openBal.length)return FP.openBal.filter(b=>b.active).reduce((s,b)=>s+b.amount,0);
  return DB.bal||0
}

function calcCashBalance(){
  return getOpenBal()+DB.ops.reduce((a,o)=>a+delta(o),0)
}

// ===== CORE: calcFP() ‚Äî pure calculation, no DOM =====
function calcFP(){
  const activeAccounts=FP.accounts.filter(a=>a.active);
  const activeOB=FP.openBal.filter(b=>b.active);
  const opsNet=DB.ops.reduce((a,o)=>a+delta(o),0);
  const activeObls=(FP.obligations||[]).filter(o=>o.active);
  const manualAssets=FP.assets.filter(a=>a.active);

  function obForAcct(acctId){return activeOB.find(b=>b.accountId===acctId)}
  const legacyOB=activeOB.filter(b=>!b.accountId);

  // --- LIQUID ASSETS: affects_cash=true, side=asset ---
  const liquidAccounts=[];
  const assetCats=SEED_ACCT_CATS.filter(c=>c.side==='asset'&&c.id!=='ac6');
  assetCats.forEach(cat=>{
    activeAccounts.filter(a=>a.catId===cat.id&&a.affectsCash).forEach(acct=>{
      const ob=obForAcct(acct.id);
      liquidAccounts.push({acct,cat,ob,bal:ob?ob.amount:0})
    })
  });
  let totalLiquid=liquidAccounts.reduce((s,x)=>s+x.bal,0);
  const legacyLiquid=legacyOB.reduce((s,b)=>s+b.amount,0);
  totalLiquid+=legacyLiquid;
  totalLiquid+=opsNet;
  const manualAssetTotal=manualAssets.reduce((s,a)=>s+a.amount,0);
  totalLiquid+=manualAssetTotal;

  // --- NON-LIQUID ASSETS ---
  const nonLiquidAccounts=[];
  assetCats.forEach(cat=>{
    activeAccounts.filter(a=>a.catId===cat.id&&!a.affectsCash).forEach(acct=>{
      const ob=obForAcct(acct.id);
      nonLiquidAccounts.push({acct,cat,ob,bal:ob?ob.amount:0})
    })
  });
  const totalNonLiquid=nonLiquidAccounts.reduce((s,x)=>s+x.bal,0);

  // --- RECEIVABLES ---
  const recvAccounts=[];
  activeAccounts.filter(a=>a.catId==='ac6').forEach(acct=>{
    const ob=obForAcct(acct.id);
    recvAccounts.push({acct,cat:SEED_ACCT_CATS.find(c=>c.id==='ac6'),ob,bal:ob?ob.amount:0})
  });
  const totalRecv=recvAccounts.reduce((s,x)=>s+x.bal,0);

  // --- OBLIGATIONS (unified) ---
  const liabAccounts=[];
  activeAccounts.filter(a=>a.catId==='ac7').forEach(acct=>{
    const ob=obForAcct(acct.id);
    if(ob&&ob.amount>0)liabAccounts.push({acct,ob,bal:ob.amount})
  });
  const liabAccountsTotal=liabAccounts.reduce((s,x)=>s+x.bal,0);
  const oblTotal=activeObls.reduce((s,o)=>s+o.amount,0);
  const totalLiab=liabAccountsTotal+oblTotal;

  // Breakdown by type
  const oblByType={client:0,transit:0,accrued:0,other:0};
  activeObls.forEach(o=>{oblByType[o.type]=(oblByType[o.type]||0)+o.amount});

  // --- NET POSITION ---
  const realPosition=totalLiquid-totalLiab;
  const fullPosition=totalLiquid+totalNonLiquid-totalLiab;
  const liabRatio=totalLiquid>0?totalLiab/totalLiquid:0;

  // --- Liquidity breakdown ---
  const liqByLevel={high:0,medium:0,low:0};
  liquidAccounts.forEach(x=>{liqByLevel[x.acct.liquidity]=(liqByLevel[x.acct.liquidity]||0)+x.bal});
  liqByLevel.high+=legacyLiquid+opsNet+manualAssetTotal;

  return{
    liquidAccounts,totalLiquid,legacyOB,legacyLiquid,opsNet,manualAssets,manualAssetTotal,
    nonLiquidAccounts,totalNonLiquid,
    recvAccounts,totalRecv,
    liabAccounts,liabAccountsTotal,activeObls,oblTotal,oblByType,totalLiab,
    realPosition,fullPosition,liabRatio,liqByLevel,
    hasData:!!(FP.accounts.length||FP.openBal.length||(FP.obligations||[]).length||DB.ops.length||FP.assets.length)
  }
}

function renderFP(){
  const now=new Date();
  $('fpDate').textContent='–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ '+now.toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
  const fp=calcFP();

  // === LIQUID ASSETS BLOCK ===
  let liqHtml='';
  // Group by category
  const liqByCat={};
  fp.liquidAccounts.forEach(x=>{
    if(!liqByCat[x.cat.id])liqByCat[x.cat.id]={cat:x.cat,items:[]};
    liqByCat[x.cat.id].items.push(x)
  });
  Object.values(liqByCat).forEach(g=>{
    liqHtml+=`<div style="margin-bottom:2px;font-size:9.5px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.6px;padding-top:6px">${g.cat.icon} ${g.cat.name}</div>`;
    g.items.forEach(x=>{
      liqHtml+=`<div class="fp-line"><div class="fp-line-name">${g.cat.icon} ${esc(x.acct.name)}${x.acct.isPersonal?'<span class="acct-personal" style="margin-left:6px">‚ö† –õ–∏—á–Ω–∞—è</span>':''}</div><div class="fp-line-amt mono pos">${x.ob?fR(x.bal):'<span style="color:var(--mt)">‚Äî</span>'}</div></div>`
    })
  });
  // Legacy OBs
  fp.legacyOB.forEach(b=>{
    liqHtml+=`<div class="fp-line"><div class="fp-line-name">${esc(b.name)}</div><div class="fp-line-amt mono pos">${fR(b.amount)}</div></div>`
  });
  // Manual assets (legacy) ‚Äî show only if exist, no "–¥–≤–∏–∂–µ–Ω–∏–µ" noise
  if(fp.manualAssets.length){
    liqHtml+=`<div class="fp-section-sep"></div>`;
    fp.manualAssets.forEach(a=>{
      liqHtml+=`<div class="fp-line"><div class="fp-line-name">${esc(a.name)}</div><div class="fp-line-amt mono pos">${fR(a.amount)}</div>${a.comment?`<div class="fp-line-comment">${esc(a.comment)}</div>`:''}</div>`
    });
  }
  // Liquidity breakdown footer
  if(fp.liquidAccounts.length>1||fp.legacyOB.length){
    
  }
  if(!liqHtml){
    const fallback=getOpenBal()+fp.opsNet;
    liqHtml=`<div class="fp-line"><div class="fp-line-name">–î–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ)</div><div class="fp-line-amt mono pos">${fR(fallback)}</div></div>`
  }
  $('fpLiqLines').innerHTML=liqHtml;
  $('fpLiqTotal').textContent=fR(fp.totalLiquid);

  // === NON-LIQUID ASSETS BLOCK ===
  let otherHtml='';
  const nlByCat={};
  fp.nonLiquidAccounts.forEach(x=>{
    if(!nlByCat[x.cat.id])nlByCat[x.cat.id]={cat:x.cat,items:[]};
    nlByCat[x.cat.id].items.push(x)
  });
  Object.values(nlByCat).forEach(g=>{
    otherHtml+=`<div style="margin-bottom:2px;font-size:9.5px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.6px;padding-top:6px">${g.cat.icon} ${g.cat.name}</div>`;
    g.items.forEach(x=>{
      otherHtml+=`<div class="fp-line"><div class="fp-line-name">${g.cat.icon} ${esc(x.acct.name)}</div><div class="fp-line-amt mono" style="color:var(--tx2)">${x.ob?fR(x.bal):'<span style="color:var(--mt)">‚Äî</span>'}</div></div>`
    })
  });
  if(!otherHtml)otherHtml='<div style="color:var(--mt);font-size:11px;padding:8px 0">–ù–µ—Ç –Ω–µ–ª–∏–∫–≤–∏–¥–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤ (—Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–±–∏–Ω–µ—Ç—ã, —Å–µ—Ä–≤–∏—Å—ã, —Ñ–æ–Ω–¥—ã).</div>';
  $('fpOtherLines').innerHTML=otherHtml;
  $('fpOtherTotal').textContent=fR(fp.totalNonLiquid);

  // === RECEIVABLES BLOCK ===
  let recvHtml='';
  fp.recvAccounts.forEach(x=>{
    recvHtml+=`<div class="fp-line"><div class="fp-line-name">üìÑ ${esc(x.acct.name)}${x.acct.comment?` <span style="color:var(--mt);font-size:10px">${esc(x.acct.comment)}</span>`:''}</div><div class="fp-line-amt mono" style="color:var(--yl)">${x.ob?fR(x.bal):'<span style="color:var(--mt)">‚Äî</span>'}</div></div>`
  });
  if(!recvHtml)recvHtml='<div style="color:var(--mt);font-size:11px;padding:8px 0">–î–µ–±–∏—Ç–æ—Ä–∫–∏ –Ω–µ—Ç. –≠—Ç–æ —Ö–æ—Ä–æ—à–æ.</div>';
  $('fpRecvLines').innerHTML=recvHtml;
  $('fpRecvTotal').textContent=fR(fp.totalRecv);

  // === UNIFIED OBLIGATIONS BLOCK ===
  let liabHtml='';
  // Filter bar
  const allObls=FP.obligations||[];
  const oblCounts={all:fp.activeObls.length+fp.liabAccounts.length};
  OBL_ORDER.forEach(t=>{const c=fp.activeObls.filter(o=>o.type===t).length;if(c)oblCounts[t]=c});
  let filterHtml=`<div class="obl-filter-pill${oblFilter==='all'?' on':''}" onclick="oblFilter='all';renderFP()">–í—Å–µ<span class="obl-cnt">${oblCounts.all}</span></div>`;
  OBL_ORDER.forEach(t=>{if(oblCounts[t])filterHtml+=`<div class="obl-filter-pill${oblFilter===t?' on':''}" onclick="oblFilter='${t}';renderFP()">${OBL_ICONS[t]} ${OBL_TYPES[t]}<span class="obl-cnt">${oblCounts[t]}</span></div>`});
  const filterEl=$('oblFilterBar');if(filterEl)filterEl.innerHTML=oblCounts.all>0?filterHtml:'';

  // ac7 accounts (always shown unless filtered to specific type)
  if(oblFilter==='all'){
    fp.liabAccounts.forEach(x=>{
      liabHtml+=`<div class="fp-line"><div class="fp-line-name">‚ö†Ô∏è ${esc(x.acct.name)}${x.acct.comment?` <span style="color:var(--mt);font-size:10px">${esc(x.acct.comment)}</span>`:''}</div><div class="fp-line-amt mono neg">${fR(x.bal)}</div></div>`
    });
  }

  // Group active obligations by type
  const oblGrouped={};
  fp.activeObls.forEach((o,idx)=>{
    if(oblFilter!=='all'&&o.type!==oblFilter)return;
    if(!oblGrouped[o.type])oblGrouped[o.type]=[];
    // Find original index in FP.obligations
    const origIdx=allObls.indexOf(o);
    oblGrouped[o.type].push({o,origIdx})
  });
  OBL_ORDER.forEach(t=>{
    if(!oblGrouped[t])return;
    if(oblFilter==='all'&&Object.keys(oblGrouped).length>1){
      liabHtml+=`<div class="obl-group-hdr">${OBL_ICONS[t]} ${OBL_TYPES[t]} ¬∑ ${fR(fp.oblByType[t])}</div>`;
    }
    oblGrouped[t].forEach(({o,origIdx})=>{
      const flags=[];
      if(o.foreignMoney)flags.push('<span class="obl-flag obl-flag-foreign">—á—É–∂–∏–µ ‚ÇΩ</span>');
      if(o.settled)flags.push('<span class="obl-flag obl-flag-settled">—Å–ø–∏—Å–∞–Ω–æ</span>');
      liabHtml+=`<div class="fp-line"><div class="fp-line-name">${OBL_ICONS[o.type]||''} ${esc(o.name)}${flags.join('')}</div><div class="fp-line-amt mono neg">${fR(o.amount)}</div>${o.comment?`<div class="fp-line-comment">${esc(o.comment)}</div>`:''}<div style="grid-column:1/-1;text-align:right"><button class="btn btn-o" style="padding:2px 6px;font-size:9px" onclick="editObl(${origIdx})">‚úé</button> <button class="btn btn-d" style="padding:2px 6px;font-size:9px" onclick="toggleObl(${origIdx},false)">–°–∫—Ä—ã—Ç—å</button></div></div>`
    })
  });

  // Inactive (dimmed)
  if(oblFilter==='all'){
    allObls.filter(o=>!o.active).forEach((o,_,__,origIdx)=>{
      origIdx=allObls.indexOf(o);
      liabHtml+=`<div class="fp-line fp-off"><div class="fp-line-name">${OBL_ICONS[o.type]||''} ${esc(o.name)}</div><div class="fp-line-amt mono" style="color:var(--mt)">${fR(o.amount)}</div><div style="grid-column:1/-1;text-align:right"><button class="btn btn-o" style="padding:2px 6px;font-size:9px" onclick="toggleObl(${origIdx},true)">–í–∫–ª</button></div></div>`
    })
  }

  if(!liabHtml)liabHtml='<div style="color:var(--mt);font-size:11px;padding:8px 0">–ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤. –î–æ–±–∞–≤—å, –µ—Å–ª–∏ –µ—Å—Ç—å —á—É–∂–∏–µ –¥–µ–Ω—å–≥–∏ –∏–ª–∏ –¥–æ–ª–≥–∏.</div>';
  $('fpLiabLines').innerHTML=liabHtml;
  $('fpLiabTotal').textContent=fR(fp.totalLiab);

  // === NET POSITION (hero) ===
  const net=fp.realPosition;
  let status,statusCls,statusIcon;
  if(net>0&&fp.liabRatio<0.5){status='–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è';statusCls='plus';statusIcon='üü¢'}
  else if(net>=0){status='–ù–∞ –≥—Ä–∞–Ω–∏';statusCls='edge';statusIcon='üü°'}
  else{status='–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è';statusCls='minus';statusIcon='üî¥'}
  $('fpNet').className='fp-net '+statusCls;
  let netHtml=`<div class="fp-net-label">–†–µ–∞–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è</div><div class="fp-net-val mono ${net>=0?'pos':'neg'}">${net>=0?'+':''}${fR(net)}</div><div class="fp-net-status">${statusIcon} ${status}</div>`;
  netHtml+=`<div style="display:flex;justify-content:center;gap:24px;margin-top:10px;font-size:10.5px;color:var(--mt)"><span>–õ–∏–∫–≤–∏–¥–Ω—ã–µ: <b class="mono pos">${fR(fp.totalLiquid)}</b></span><span>–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞: <b class="mono neg">${fR(fp.totalLiab)}</b></span></div>`;
  if(fp.totalRecv>0)netHtml+=`<div style="text-align:center;margin-top:4px;font-size:10px;color:var(--yl)">–î–µ–±–∏—Ç–æ—Ä–∫–∞ ${fR(fp.totalRecv)} ‚Äî –Ω–µ —É—á—Ç–µ–Ω–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏</div>`;
  if(fp.totalNonLiquid>0)netHtml+=`<div style="text-align:center;margin-top:2px;font-size:10px;color:var(--tx2)">–ù–µ–ª–∏–∫–≤–∏–¥–Ω—ã–µ –∞–∫—Ç–∏–≤—ã ${fR(fp.totalNonLiquid)} ‚Äî –Ω–µ —É—á—Ç–µ–Ω—ã</div>`;
  $('fpNet').innerHTML=netHtml;

  // === INTERPRETATION ===
  $('fpInterp').innerHTML=fpInterpretation(fp);

  // === SUB-FORMS ===
  renderOpenBal()
}

function fpInterpretation(fp){
  if(!fp.hasData)return'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–≥—Ä—É–∑–∏ –≤—ã–ø–∏—Å–∫—É –∏ –¥–æ–±–∞–≤—å –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.';
  const parts=[];

  // 1. Real position verdict
  if(fp.realPosition>=0){
    parts.push(`–†–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è <b class="pos">+${fR(fp.realPosition)}</b> ‚Äî –ª–∏–∫–≤–∏–¥–Ω—ã–µ –∞–∫—Ç–∏–≤—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞.`)
  } else {
    parts.push(`–†–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è <b class="neg">${fR(fp.realPosition)}</b> ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø—Ä–µ–≤—ã—à–∞—é—Ç –ª–∏–∫–≤–∏–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ <b class="neg">${fR(Math.abs(fp.realPosition))}</b>.`)
  }

  // 2. Liability ratio (from liquid assets)
  if(fp.totalLiquid>0&&fp.totalLiab>0){
    const pct=((fp.totalLiab/fp.totalLiquid)*100).toFixed(0);
    if(pct>=40)parts.push(`<b>${pct}%</b> –ª–∏–∫–≤–∏–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞. ${pct>=70?'–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å.':'–í–Ω–∏–º–∞–Ω–∏–µ.'}`)
  }

  // 3. Receivables warning
  if(fp.totalRecv>0){
    if(fp.totalRecv>fp.totalLiquid*0.3){
      parts.push(`–î–µ–±–∏—Ç–æ—Ä–∫–∞ <b>${fR(fp.totalRecv)}</b> —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç <b>${((fp.totalRecv/fp.totalLiquid)*100).toFixed(0)}%</b> –æ—Ç –ª–∏–∫–≤–∏–¥–Ω—ã—Ö. –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –∫–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑—Ä—ã–≤–∞ –ø—Ä–∏ –∑–∞–¥–µ—Ä–∂–∫–µ –æ–ø–ª–∞—Ç.`)
    } else {
      parts.push(`–î–µ–±–∏—Ç–æ—Ä–∫–∞ <b>${fR(fp.totalRecv)}</b> ‚Äî –Ω–µ —É—á—Ç–µ–Ω–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –æ–ø–ª–∞—Ç—ã.`)
    }
  }

  // 4. Non-liquid assets info
  if(fp.totalNonLiquid>0){
    parts.push(`–ù–µ–ª–∏–∫–≤–∏–¥–Ω—ã–µ –∞–∫—Ç–∏–≤—ã <b>${fR(fp.totalNonLiquid)}</b> (—Ä–µ–∫–ª. –∫–∞–±–∏–Ω–µ—Ç—ã, —Å–µ—Ä–≤–∏—Å—ã, —Ñ–æ–Ω–¥—ã) ‚Äî –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∫–µ—à –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.`)
  }

  // 5. Client obligations share
  if(fp.oblByType.client>0&&fp.totalLiab>0){
    const pct=((fp.oblByType.client/fp.totalLiab)*100).toFixed(0);
    if(pct>=30)parts.push(`–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ ‚Äî <b>${pct}%</b> –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ (${fR(fp.oblByType.client)}).`)
  }
  // Transit obligations
  if(fp.oblByType.transit>0){
    parts.push(`–¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞: <b>${fR(fp.oblByType.transit)}</b> ‚Äî —á—É–∂–∏–µ –¥–µ–Ω—å–≥–∏, —É–∂–µ –≤ –¥–≤–∏–∂–µ–Ω–∏–∏.`)
  }

  // 6. Runway
  if(fp.realPosition>0){
    const now=new Date();const m3=new Date(now);m3.setMonth(m3.getMonth()-3);
    const recentExp=DB.ops.filter(o=>o.t==='out'&&o.d>=ds(m3)).reduce((s,o)=>s+Math.abs(o.a),0);
    const avgMonthly=recentExp/3;
    if(avgMonthly>0){
      const runway=(fp.realPosition/avgMonthly).toFixed(1);
      parts.push(`–ó–∞–ø–∞—Å –ø—Ä–æ—á–Ω–æ—Å—Ç–∏: <b>${runway} –º–µ—Å.</b> –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ —Ä–∞—Å—Ö–æ–¥–æ–≤.`)
    }
  }

  // 7. Estimate warning
  const estimates=[...FP.assets,...(FP.obligations||[])].filter(x=>x.active&&x.confidence==='estimate');
  if(estimates.length)parts.push(`<span style="color:var(--mt)">${estimates.length} –ø–æ–∑–∏—Ü–∏${estimates.length===1?'—è':'–π'} —Å –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π.</span>`);

  return parts.join(' ')||'–î–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.'
}

// ========== FP CRUD ==========
function openFpModal(side){
  if(side!=='asset')return; // liabilities now handled by openOblModal
  const types=FP_ASSET_TYPES;
  const typeOpts=Object.entries(types).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');
  const items=FP.assets;

  let listHtml='';
  if(items.length){
    listHtml='<div style="margin-bottom:14px;max-height:200px;overflow-y:auto">';
    items.forEach((it,i)=>{
      listHtml+=`<div class="fp-entry-row${it.active?'':' fp-off'}"><span style="flex:1;font-size:11px">${esc(it.name)} ¬∑ <span class="mono" style="font-size:10px">${fR(it.amount)}</span></span>${it.active?`<button class="btn btn-d" style="padding:2px 6px;font-size:9px" onclick="deactivateFp('assets',${i})">–°–∫—Ä—ã—Ç—å</button>`:`<button class="btn btn-o" style="padding:2px 6px;font-size:9px" onclick="reactivateFp('assets',${i})">–í–∫–ª</button>`}</div>`
    });
    listHtml+='</div>'
  }

  showModal(`<h3>–ê–∫—Ç–∏–≤—ã</h3>
    ${listHtml}
    <div style="border-top:1px solid var(--bd);padding-top:14px;margin-top:8px">
      <div class="form-g" style="margin-bottom:10px"><label>–¢–∏–ø</label><select id="_fpType">${typeOpts}</select></div>
      <div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_fpName" placeholder="–¢–∏–Ω—å–∫–æ—Ñ—Ñ –∫–∞—Ä—Ç–∞"></div>
      <div class="form-g" style="margin-bottom:10px"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" id="_fpAmt" placeholder="100000" min="0" step="1000"></div>
      <div class="form-row" style="margin-bottom:10px">
        <div class="form-g"><label>–¢–æ—á–Ω–æ—Å—Ç—å</label><select id="_fpConf"><option value="exact">–¢–æ—á–Ω–∞—è</option><option value="estimate">–û—Ü–µ–Ω–∫–∞</option></select></div>
      </div>
      <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)</label><input id="_fpComment" placeholder="–ü–æ—è—Å–Ω–µ–Ω–∏–µ..."></div>
      <div class="btn-grp"><button class="btn btn-p" onclick="addFpItem('asset')">–î–æ–±–∞–≤–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>`)
}

function addFpItem(side){
  if(side!=='asset')return;
  const name=$('_fpName').value.trim();
  const amt=parseFloat($('_fpAmt').value);
  const comment=$('_fpComment').value.trim();
  if(!name){toast('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');return}
  if(!amt||amt<=0){toast('–£–∫–∞–∂–∏ —Å—É–º–º—É','err');return}
  if(!comment){toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω','err');return}
  const item={id:uid(),type:$('_fpType').value,name,amount:amt,confidence:$('_fpConf').value,comment,active:true,updatedAt:new Date().toISOString()};
  FP.assets.push(item);
  save();renderFP();closeModal();toast('–î–æ–±–∞–≤–ª–µ–Ω–æ')
}
function deactivateFp(col,i){FP[col][i].active=false;FP[col][i].updatedAt=new Date().toISOString();save();renderFP();closeModal();toast('–°–∫—Ä—ã—Ç–æ')}
function reactivateFp(col,i){FP[col][i].active=true;FP[col][i].updatedAt=new Date().toISOString();save();renderFP();closeModal();toast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')}

// ========== OPENING BALANCE CRUD ==========
const OB_TYPES={account:'–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç',card:'–ö–∞—Ä—Ç–∞',service:'–ë–∞–ª–∞–Ω—Å —Å–µ—Ä–≤–∏—Å–∞',reserve:'–†–µ–∑–µ—Ä–≤ / —Ñ–æ–Ω–¥'};

function obAcctLabel(b){
  // If linked to account, show account info. Otherwise legacy label.
  if(b.accountId){const a=FP.accounts.find(x=>x.id===b.accountId);if(a){const c=acctCat(a.catId);return{name:a.name,icon:c?c.icon:'',catName:c?c.name:'',typeCls:catToCls(a.catId)}}}
  return{name:b.name||'?',icon:'',catName:OB_TYPES[b.type]||b.type,typeCls:'fp-type-'+(b.type||'account')}
}
function catToCls(catId){
  const map={ac1:'account',ac2:'card',ac3:'service',ac4:'service',ac5:'reserve',ac6:'other',ac7:'client'};
  return'fp-type-'+(map[catId]||'account')
}

function renderOpenBal(){
  const items=FP.openBal;const total=items.filter(b=>b.active).reduce((s,b)=>s+b.amount,0);
  $('obTotal').textContent=fR(total);
  let h='';
  items.forEach((b,i)=>{
    const cls=b.active?'':'fp-off';
    const lbl=obAcctLabel(b);
    h+=`<div class="fp-line ${cls}" ${b.active?`style="cursor:pointer" onclick="editOb(${i})"`:''} ><div class="fp-line-name">${lbl.icon} ${esc(lbl.name)}</div><div class="fp-line-amt mono${b.active?' pos':''}" ${b.active?'':'style="color:var(--mt)"'}>${fR(b.amount)}</div>${b.comment&&b.active?`<div class="fp-line-comment">${esc(b.comment)}</div>`:''}${b.active?`<div style="grid-column:1/-1;text-align:right"><button class="btn btn-o" style="padding:2px 6px;font-size:9px" onclick="event.stopPropagation();editOb(${i})">‚úé</button> <button class="btn btn-d" style="padding:2px 6px;font-size:9px" onclick="event.stopPropagation();if(CURRENT_USER?.role!=='owner'){toast('–¢–æ–ª—å–∫–æ owner','err');return}FP.openBal[${i}].active=false;save();renderFP();toast('–°–∫—Ä—ã—Ç')">–°–∫—Ä—ã—Ç—å</button></div>`:`<div style="grid-column:1/-1;text-align:right"><button class="btn btn-o" style="padding:2px 6px;font-size:9px" onclick="if(CURRENT_USER?.role!=='owner'){toast('–¢–æ–ª—å–∫–æ owner','err');return}FP.openBal[${i}].active=true;save();renderFP();toast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')">–í–∫–ª</button></div>`}</div>`
  });
  if(!items.length)h='<div style="color:var(--mt);font-size:11px;padding:6px 0">–î–æ–±–∞–≤—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º –∏ –∫–∞—Ä—Ç–∞–º.</div>';
  $('obLines').innerHTML=h;
  const el=$('obSummary');if(el)el.textContent=items.filter(b=>b.active).length?`${items.filter(b=>b.active).length} —Å—á–µ—Ç–æ–≤ ¬∑ ${fR(total)}`:'–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'
}

function editOb(i){
  if(CURRENT_USER?.role!=='owner'){toast('–¢–æ–ª—å–∫–æ owner','err');return}
  const b=FP.openBal[i];if(!b)return;
  const lbl=obAcctLabel(b);
  showModal(`<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫</h3>
    <div style="font-size:13px;font-weight:700;margin-bottom:14px">${esc(lbl.name)}</div>
    <div class="form-g" style="margin-bottom:12px"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" id="_obEditAmt" value="${b.amount}" min="0" step="1000"></div>
    <div class="form-g" style="margin-bottom:12px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="_obEditCm" value="${esc(b.comment||'')}"></div>
    <div class="btn-grp"><button class="btn btn-p" onclick="saveObEdit(${i})">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`)
}
function saveObEdit(i){
  const amt=parseFloat($('_obEditAmt').value);
  if(isNaN(amt)||amt<0){toast('–£–∫–∞–∂–∏ —Å—É–º–º—É','err');return}
  FP.openBal[i].amount=amt;
  FP.openBal[i].comment=$('_obEditCm').value.trim();
  save();renderFP();closeModal();toast('–û—Å—Ç–∞—Ç–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω')
}

function openObModal(){if(CURRENT_USER?.role!=="owner"){toast("–¢–æ–ª—å–∫–æ owner –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –æ—Å—Ç–∞—Ç–∫–∏","err");return}
  const activeAccounts=FP.accounts.filter(a=>a.active);
  if(!activeAccounts.length){
    showModal(`<h3>–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</h3>
      <p style="font-size:12px;color:var(--tx2);margin-bottom:14px">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π —Å—á–µ—Ç–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–°—á–µ—Ç–∞¬ª, –∑–∞—Ç–µ–º –ø—Ä–∏–≤—è–∂–∏ –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏.</p>
      <div class="btn-grp"><button class="btn btn-p" onclick="closeModal();goTab('acct')">‚Üí –°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç</button><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    return
  }
  // Exclude accounts that already have an active openBal
  const usedIds=FP.openBal.filter(b=>b.active&&b.accountId).map(b=>b.accountId);
  const available=activeAccounts.filter(a=>!usedIds.includes(a.id));
  if(!available.length){
    showModal(`<h3>–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</h3><p style="font-size:12px;color:var(--tx2);margin-bottom:14px">–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—á–µ—Ç–∞ —É–∂–µ –∏–º–µ—é—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏.</p><div class="btn-grp"><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
    return
  }
  const acctOpts=available.map(a=>{const c=acctCat(a.catId);return`<option value="${a.id}">${c?c.icon+' ':''} ${a.name}</option>`}).join('');
  showModal(`<h3>–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</h3>
    <p style="font-size:11px;color:var(--tx2);margin-bottom:14px">–£–∫–∞–∂–∏ –±–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞ –Ω–∞ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —É—á—ë—Ç–∞.</p>
    <div class="form-g" style="margin-bottom:10px"><label>–°—á—ë—Ç</label><select id="_obAcct">${acctOpts}</select></div>
    <div class="form-row"><div class="form-g" style="margin-bottom:10px"><label>–û—Å—Ç–∞—Ç–æ–∫ ‚ÇΩ</label><input type="number" id="_obAmt" placeholder="420000" min="0" step="1000"></div>
    <div class="form-g" style="margin-bottom:10px"><label>–î–∞—Ç–∞ –æ—Å—Ç–∞—Ç–∫–∞</label><input type="date" id="_obDate" value="${new Date().toISOString().slice(0,10)}"></div></div>
    <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)</label><input id="_obComment" placeholder="–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ 01.01.2026"></div>
    <div class="btn-grp"><button class="btn btn-p" onclick="addOb()">–î–æ–±–∞–≤–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`)
}

function addOb(){
  const accountId=$('_obAcct').value,amt=parseFloat($('_obAmt').value),comment=$('_obComment').value.trim();
  const obDate=$('_obDate')?.value||new Date().toISOString().slice(0,10);
  const acct=FP.accounts.find(a=>a.id===accountId);
  if(!acct){toast('–í—ã–±–µ—Ä–∏ —Å—á—ë—Ç','err');return}
  if(isNaN(amt)||amt<0){toast('–£–∫–∞–∂–∏ —Å—É–º–º—É','err');return}
  if(!comment){toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω','err');return}
  FP.openBal.push({id:uid(),accountId,name:acct.name,type:null,amount:amt,comment,active:true,date:obDate,createdAt:new Date().toISOString()});
  save();renderFP();closeModal();toast('–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω')
}

// ========== UNIFIED OBLIGATIONS CRUD ==========
function toggleObl(i,active){
  if(!FP.obligations||!FP.obligations[i])return;
  FP.obligations[i].active=active;
  FP.obligations[i].updatedAt=new Date().toISOString();
  save();renderFP();toast(active?'–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ':'–°–∫—Ä—ã—Ç–æ')
}

function openOblModal(){
  showModal(`<h3>–î–æ–±–∞–≤–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</h3>
    <p style="font-size:10.5px;color:var(--tx2);margin-bottom:14px">–¢–æ–ª—å–∫–æ <b>—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ</b> –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –∫–µ—à.<br>–ö—Ä–µ–¥–∏—Ç—ã, –Ω–∞–ª–æ–≥–∏, —Ä–∞—Å—Å—Ä–æ—á–∫–∏ ‚Üí —Ñ–∏–Ω–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å).</p>
    <div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_oblName" placeholder="–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ / –¥–æ–ª–≥ –ø–æ–¥—Ä—è–¥—á–∏–∫—É..."></div>
    <div class="form-g" style="margin-bottom:10px"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" id="_oblAmt" placeholder="150000" min="0" step="1000"></div>
    <div style="display:flex;gap:16px;margin-bottom:14px">
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;padding:8px 14px;border-radius:10px;border:1px solid var(--bd);flex:1;background:var(--sf)">
        <input type="checkbox" id="_oblForeign" onchange="updateOblTypeHint()"> <span>–ß—É–∂–∏–µ –¥–µ–Ω—å–≥–∏?</span>
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;padding:8px 14px;border-radius:10px;border:1px solid var(--bd);flex:1;background:var(--sf)">
        <input type="checkbox" id="_oblSettled" onchange="updateOblTypeHint()"> <span>–£–∂–µ —Å–ø–∏—Å–∞–ª–∏—Å—å?</span>
      </label>
    </div>
    <div id="_oblTypeHint" style="font-size:10px;padding:6px 10px;border-radius:8px;background:var(--sf);margin-bottom:14px;color:var(--tx2)">‚Üí –¢–∏–ø: <b>–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ</b> ‚Äî —Å–≤–æ–∏ –¥–µ–Ω—å–≥–∏, –µ—â—ë –Ω–µ —Å–ø–∏—Å–∞–ª–∏—Å—å</div>
    <div class="form-row" style="margin-bottom:10px">
      <div class="form-g"><label>–¢–æ—á–Ω–æ—Å—Ç—å</label><select id="_oblConf"><option value="exact">–¢–æ—á–Ω–∞—è</option><option value="estimate">–û—Ü–µ–Ω–∫–∞</option></select></div>
    </div>
    <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="_oblComment" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞"></div>
    <div class="btn-grp"><button class="btn btn-p" onclick="addObl()">–î–æ–±–∞–≤–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`)
}

const OBL_HINTS={client:'–ß—É–∂–∏–µ –¥–µ–Ω—å–≥–∏, –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤)',transit:'–ß—É–∂–∏–µ –¥–µ–Ω—å–≥–∏, –≤ –¥–≤–∏–∂–µ–Ω–∏–∏ (—Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ)',accrued:'–°–≤–æ–∏ –¥–µ–Ω—å–≥–∏, –Ω–µ —Å–ø–∏—Å–∞–ª–∏—Å—å (–Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ)',other:'–ü—Ä–æ—á–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ª–≥–∏'};
function updateOblTypeHint(){
  const fm=$('_oblForeign')?.checked;const st=$('_oblSettled')?.checked;const t=oblType(fm,st);
  const el=$('_oblTypeHint');if(el)el.innerHTML=`‚Üí –¢–∏–ø: <b>${OBL_TYPES[t]}</b> ‚Äî ${OBL_HINTS[t]}`
}

function addObl(){
  const name=$('_oblName').value.trim();const amt=parseFloat($('_oblAmt').value);const comment=$('_oblComment').value.trim();
  if(!name){toast('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');return}
  if(!amt||amt<=0){toast('–£–∫–∞–∂–∏ —Å—É–º–º—É','err');return}
  const fm=$('_oblForeign').checked;const st=$('_oblSettled').checked;const t=oblType(fm,st);
  if(!FP.obligations)FP.obligations=[];
  FP.obligations.push({id:uid(),name,amount:amt,foreignMoney:fm,settled:st,type:t,confidence:$('_oblConf').value,comment,active:true,updatedAt:new Date().toISOString()});
  save();renderFP();closeModal();toast('–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ')
}

function editObl(i){
  const o=(FP.obligations||[])[i];if(!o)return;
  showModal(`<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</h3>
    <div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_oblName" value="${esc(o.name)}"></div>
    <div class="form-g" style="margin-bottom:10px"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" id="_oblAmt" value="${o.amount}" min="0" step="1000"></div>
    <div style="display:flex;gap:16px;margin-bottom:14px">
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;padding:8px 14px;border-radius:10px;border:1px solid var(--bd);flex:1;background:var(--sf)">
        <input type="checkbox" id="_oblForeign" ${o.foreignMoney?'checked':''} onchange="updateOblTypeHint()"> <span>–ß—É–∂–∏–µ –¥–µ–Ω—å–≥–∏?</span>
      </label>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;padding:8px 14px;border-radius:10px;border:1px solid var(--bd);flex:1;background:var(--sf)">
        <input type="checkbox" id="_oblSettled" ${o.settled?'checked':''} onchange="updateOblTypeHint()"> <span>–£–∂–µ —Å–ø–∏—Å–∞–ª–∏—Å—å?</span>
      </label>
    </div>
    <div id="_oblTypeHint" style="font-size:10px;padding:6px 10px;border-radius:8px;background:var(--sf);margin-bottom:14px;color:var(--tx2)">‚Üí –¢–∏–ø: <b>${OBL_TYPES[o.type]}</b></div>
    <div class="form-row" style="margin-bottom:10px">
      <div class="form-g"><label>–¢–æ—á–Ω–æ—Å—Ç—å</label><select id="_oblConf"><option value="exact"${o.confidence==='exact'?' selected':''}>–¢–æ—á–Ω–∞—è</option><option value="estimate"${o.confidence==='estimate'?' selected':''}>–û—Ü–µ–Ω–∫–∞</option></select></div>
    </div>
    <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="_oblComment" value="${esc(o.comment||'')}"></div>
    <div class="btn-grp"><button class="btn btn-p" onclick="saveObl(${i})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`)
}

function saveObl(i){
  const name=$('_oblName').value.trim();const amt=parseFloat($('_oblAmt').value);const comment=$('_oblComment').value.trim();
  if(!name){toast('–ù–∞–∑–≤–∞–Ω–∏–µ','err');return}if(!amt||amt<=0){toast('–°—É–º–º–∞','err');return}
  const fm=$('_oblForeign').checked;const st=$('_oblSettled').checked;const o=FP.obligations[i];
  o.name=name;o.amount=amt;o.foreignMoney=fm;o.settled=st;o.type=oblType(fm,st);
  o.confidence=$('_oblConf').value;o.comment=comment;o.updatedAt=new Date().toISOString();
  save();renderFP();closeModal();toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ')
}


// ========== ACCOUNTS CRUD ==========
function acctCat(id){return SEED_ACCT_CATS.find(c=>c.id===id)}
function acctName(id){const a=FP.accounts.find(x=>x.id===id);return a?a.name:'?'}

function renderAccounts(){
  const el=$('acctList');if(!el)return;
  if(!FP.accounts.length){el.innerHTML='<div class="empty"><div class="ei">üè¶</div><div class="et">–ù–µ—Ç —Å—á–µ—Ç–æ–≤</div><div class="ed">–î–æ–±–∞–≤—å —Ä–∞—Å—á—ë—Ç–Ω—ã–µ —Å—á–µ—Ç–∞, –∫–∞—Ä—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–µ–Ω–µ–≥</div><div class="cta" onclick="openAcctModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç</div></div>';return}

  let h='';
  SEED_ACCT_CATS.forEach(cat=>{
    const items=FP.accounts.filter(a=>a.catId===cat.id);
    if(!items.length)return;
    const activeItems=items.filter(a=>a.active);
    const catTotal=activeItems.reduce((s,a)=>{
      // Find openBal linked to this account
      const ob=FP.openBal.find(b=>b.accountId===a.id&&b.active);
      return s+(ob?ob.amount:0)
    },0);

    h+=`<div class="acct-cat-group">
      <div class="acct-cat-hdr">
        <span>${cat.icon} ${cat.name}</span>
        <span class="mono" style="font-size:13px;font-weight:700;color:${cat.side==='liability'?'var(--rd)':'var(--gr)'}">${activeItems.length?fR(catTotal):''}</span>
      </div>`;

    items.forEach((a,idx)=>{
      const cat2=acctCat(a.catId);
      const liqCls=a.liquidity==='high'?'liq-h':a.liquidity==='medium'?'liq-m':'liq-l';
      const ob=FP.openBal.find(b=>b.accountId===a.id&&b.active);
      const bal=ob?ob.amount:null;
      const globalIdx=FP.accounts.indexOf(a);

      h+=`<div class="acct-card${a.active?'':' acct-off'}">
        <div class="acct-card-top">
          <div class="acct-card-name">${esc(a.name)}${a.isPersonal?'<span class="acct-personal">‚ö† –õ–∏—á–Ω–∞—è</span>':''}</div>
          <div class="acct-card-bal mono${cat2.side==='liability'?' neg':' pos'}" style="cursor:pointer" onclick="editAcct(${globalIdx})" title="–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å">${bal!==null?fR(bal):'<span style="color:var(--mt)">‚Äî</span>'}</div>
        </div>
        <div class="acct-card-meta">
          
          ${a.affectsCash?'<span class="acct-tag acct-tag-cash">–í–ª–∏—è–µ—Ç –Ω–∞ –∫–µ—à</span>':''}
          ${cat2.side==='liability'?'<span class="acct-tag acct-tag-liab">–û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</span>':''}
        </div>
        ${a.comment?`<div class="acct-card-comment">${esc(a.comment)}</div>`:''}
        <div class="acct-card-actions">
          ${a.active?`<button class="btn btn-o" style="padding:3px 8px;font-size:9px" onclick="editAcct(${globalIdx})">‚úé</button> <button class="btn btn-d" style="padding:3px 8px;font-size:9px" onclick="deactivateAcct(${globalIdx})">–°–∫—Ä—ã—Ç—å</button>`:`<button class="btn btn-o" style="padding:3px 8px;font-size:9px" onclick="reactivateAcct(${globalIdx})">–í–∫–ª</button>`}
        </div>
      </div>`;
    });
    h+=`</div>`;
  });
  el.innerHTML=h
}

function openAcctModal(editIdx){
  const isEdit=editIdx!==undefined;
  const a=isEdit?FP.accounts[editIdx]:null;
  const catOpts=SEED_ACCT_CATS.map(c=>`<option value="${c.id}"${a&&a.catId===c.id?' selected':''}>${c.icon} ${c.name}</option>`).join('');
  const liqOpts=['high','medium','low'].map(l=>`<option value="${l}"${a&&a.liquidity===l?' selected':''}>${LIQ_LABELS[l]}</option>`).join('');
  const ob=isEdit?FP.openBal.find(b=>b.accountId===a.id&&b.active):null;

  showModal(`<h3>${isEdit?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'} —Å—á—ë—Ç</h3>
    <div class="form-g" style="margin-bottom:10px"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="_acCat" onchange="onAcctCatChange()">${catOpts}</select></div>
    <div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_acName" value="${a?esc(a.name):''}" placeholder="–¢–æ—á–∫–∞ —Ä/—Å –æ—Å–Ω–æ–≤–Ω–æ–π"></div>
    <div class="form-g" style="margin-bottom:10px"><label>–û—Å—Ç–∞—Ç–æ–∫ / —Å—É–º–º–∞ (‚ÇΩ)${CURRENT_USER?.role!=="owner"?" <span style=\"color:var(--mt);font-weight:400\">(—Ç–æ–ª—å–∫–æ owner)</span>":""}</label><input id="_acBal" type="number" step="0.01" value="${ob?ob.amount:''}" placeholder="0" ${CURRENT_USER?.role!=="owner"?"disabled style=\"opacity:.5;cursor:not-allowed\"":""}></div>
    <div class="form-row" style="margin-bottom:10px">
      <div class="form-g"><label>–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</label><select id="_acLiq">${liqOpts}</select></div>
      <div class="form-g"><label>–í–ª–∏—è–µ—Ç –Ω–∞ –∫–µ—à</label><select id="_acCash"><option value="1"${!a||a.affectsCash?' selected':''}>–î–∞</option><option value="0"${a&&!a.affectsCash?' selected':''}>–ù–µ—Ç</option></select></div>
    </div>
    <div class="form-g" style="margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="_acPersonal"${a&&a.isPersonal?' checked':''} style="accent-color:var(--yl);width:14px;height:14px"> –õ–∏—á–Ω–∞—è –∫–∞—Ä—Ç–∞ (—Ä–∏—Å–∫ —Å–º–µ—à–µ–Ω–∏—è)</label></div>
    <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="_acComment" value="${a?esc(a.comment):''}" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></div>
    <div class="btn-grp"><button class="btn btn-p" onclick="${isEdit?`saveAcct(${editIdx})`:'addAcct()'}">${isEdit?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'}</button><button class="btn btn-o" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`)

  // Set defaults from category
  if(!isEdit)onAcctCatChange()
}

function onAcctCatChange(){
  const cat=acctCat($('_acCat').value);
  if(!cat)return;
  $('_acLiq').value=cat.defLiquidity;
  $('_acCash').value=cat.defAffectsCash?'1':'0'
}

function addAcct(){
  const name=$('_acName').value.trim();
  if(!name){toast('–ù–∞–∑–≤–∞–Ω–∏–µ','err');return}
  const cat=acctCat($('_acCat').value);
  const acctId=uid();
  const bal=parseFloat($('_acBal').value)||0;
  FP.accounts.push({
    id:acctId,name,catId:$('_acCat').value,
    liquidity:$('_acLiq').value,
    affectsCash:$('_acCash').value==='1',
    active:true,
    comment:$('_acComment').value.trim(),
    isPersonal:$('_acPersonal').checked,
    createdAt:new Date().toISOString()
  });
  if(bal&&CURRENT_USER?.role==="owner"){FP.openBal.push({id:uid(),accountId:acctId,name,type:null,amount:bal,comment:'',active:true,date:new Date().toISOString().slice(0,10),createdAt:new Date().toISOString()})}
  save();renderAccounts();if(screen==='fp')renderFP();closeModal();toast('–°—á—ë—Ç –¥–æ–±–∞–≤–ª–µ–Ω')
}

function saveAcct(i){
  const name=$('_acName').value.trim();
  if(!name){toast('–ù–∞–∑–≤–∞–Ω–∏–µ','err');return}
  const a=FP.accounts[i];
  a.name=name;a.catId=$('_acCat').value;a.liquidity=$('_acLiq').value;
  a.affectsCash=$('_acCash').value==='1';a.comment=$('_acComment').value.trim();
  a.isPersonal=$('_acPersonal').checked;
  if(CURRENT_USER?.role==="owner"){
    const bal=parseFloat($('_acBal').value)||0;
    let ob=FP.openBal.find(b=>b.accountId===a.id&&b.active);
    if(bal){
      if(ob){ob.amount=bal;ob.name=name}
      else{FP.openBal.push({id:uid(),accountId:a.id,name,type:null,amount:bal,comment:'',active:true,date:new Date().toISOString().slice(0,10),createdAt:new Date().toISOString()})}
    } else if(ob){ob.active=false}
  }
  save();renderAccounts();if(screen==='fp')renderFP();closeModal();toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ')
}

function editAcct(i){openAcctModal(i)}
function deactivateAcct(i){FP.accounts[i].active=false;save();renderAccounts();toast('–°–∫—Ä—ã—Ç')}
function reactivateAcct(i){FP.accounts[i].active=true;save();renderAccounts();toast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')}

// ========== AUTO-CATEGORIZE (income + expense + special) ==========
function autocat(text,flowDir){
  const l=(text||'').toLowerCase();
  for(const r of rules){if(!r.p)continue;if(r.d&&r.d!==flowDir)continue;try{
    if(new RegExp(r.p,'i').test(l)){
      if(r.c==='_owner')return{t:'owner',expTypeId:null,svcId:null};
      if(r.c==='_internal')return{t:'internal',expTypeId:null,svcId:null};
      if(r.d==='in')return{t:r.c==='s12'?'transit':'in',svcId:r.c,expTypeId:null};
      return{t:'out',expTypeId:r.c,svcId:null}
    }
  }catch(e){}}
  return null
}
function normCp(s){return(s||'').trim().toLowerCase().replace(/\s+/g,' ')}
function resolveOp(cp,desc,flowDir){
  const key=normCp(cp);
  if(cpMap[key]){const m=cpMap[key];return{t:m.t||flowDir,svcId:m.svcId||null,expTypeId:m.expTypeId||null,source:'saved'}}
  const a=autocat((desc||'')+' '+(cp||''),flowDir);
  if(a)return{...a,source:'auto'};
  return{t:flowDir,svcId:null,expTypeId:null,source:'none'}
}

// ========== CSV PARSER ==========
function parseCSV(text){
  const ops=[];const sep=text.includes(';')?';':',';const lines=text.split('\n').map(l=>splitLine(l,sep));
  if(lines.length<2)return ops;const hdr=lines[0].map(h=>h.toLowerCase().trim().replace(/^\ufeff/,''));
  const iDate=hdr.findIndex(h=>/^–¥–∞—Ç–∞\s*(–ø—Ä–æ–≤–æ–¥|–æ–ø–µ—Ä|$)|^date/.test(h));const iFD=iDate<0?hdr.findIndex(h=>/^–¥–∞—Ç–∞/.test(h)):-1;const dateCol=iDate>=0?iDate:iFD;
  const iDir=hdr.findIndex(h=>/^–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω/.test(h));let iAmt=hdr.findIndex(h=>/^—Å—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü|^—Å—É–º–º–∞$|^amount/.test(h));
  const iAmtR=hdr.findIndex(h=>/—Å—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ä—É–±–ª/.test(h));if(iAmtR>=0)iAmt=iAmtR;
  const iDeb=hdr.findIndex(h=>!/^–¥–∞—Ç–∞/.test(h)&&/^(—Ä–∞—Å—Ö–æ–¥|debit|–¥–µ–±–µ—Ç|—Å–ø–∏—Å–∞–Ω)/.test(h));const iCred=hdr.findIndex(h=>!/^–¥–∞—Ç–∞/.test(h)&&/^(–ø—Ä–∏—Ö–æ–¥|credit|–∫—Ä–µ–¥–∏—Ç|–∑–∞—á–∏—Å–ª–µ–Ω|–ø–æ—Å—Ç—É–ø–ª–µ–Ω)/.test(h));
  const iDesc=hdr.findIndex(h=>/–Ω–∞–∑–Ω–∞—á–µ–Ω|–æ–ø–∏—Å–∞–Ω|desc|–æ—Å–Ω–æ–≤–∞–Ω/.test(h));const iPayer=hdr.findIndex(h=>/–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω.*–ø–ª–∞—Ç–µ–ª—å—â/.test(h));const iRecv=hdr.findIndex(h=>/–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω.*–ø–æ–ª—É—á–∞—Ç–µ–ª/.test(h));const iCp=hdr.findIndex(h=>/^–∫–æ–Ω—Ç—Ä–∞–≥|^counterparty/.test(h));
  if(dateCol<0)return ops;
  for(let i=1;i<lines.length;i++){const r=lines[i];if(!r||r.length<=dateCol)continue;const date=pDate(r[dateCol]);if(!date)continue;
    let amt=0,dir='';
    if(iDir>=0&&iAmt>=0){amt=pNum(r[iAmt]);if(!amt)continue;const dv=(r[iDir]||'').toLowerCase();if(/–∏—Å—Ö–æ–¥—è—â|—Ä–∞—Å—Ö–æ–¥|debit|out/.test(dv))dir='out';else if(/–≤—Ö–æ–¥—è—â|–ø—Ä–∏—Ö–æ–¥|credit|in/.test(dv))dir='in';else dir=amt>0?'in':'out';amt=Math.abs(amt)}
    else if(iDeb>=0&&iCred>=0){const d=pNum(r[iDeb]),c=pNum(r[iCred]);if(c>0){amt=c;dir='in'}else if(d>0){amt=d;dir='out'}else continue}
    else if(iAmt>=0){amt=pNum(r[iAmt]);if(amt>0)dir='in';else if(amt<0){dir='out';amt=Math.abs(amt)}else continue}
    else continue;
    let cp='';if(iCp>=0)cp=r[iCp]||'';else if(dir==='out'&&iRecv>=0)cp=r[iRecv]||'';else if(dir==='in'&&iPayer>=0)cp=r[iPayer]||'';else if(iPayer>=0)cp=r[iPayer]||'';
    ops.push({d:date,a:amt,dir,cp:cp.trim().slice(0,120),cm:((iDesc>=0?r[iDesc]:'')||'').trim().slice(0,250)})}
  return ops}
function splitLine(l,sep){const r=[];let c='',q=false;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='"'){if(q&&l[i+1]==='"'){c+='"';i++;continue}q=!q}else if(ch===sep&&!q){r.push(c);c=''}else if(ch!=='\r')c+=ch}r.push(c);return r.map(x=>x.trim())}
function pNum(s){if(!s)return 0;return parseFloat(String(s).replace(/[\s\u00A0]/g,'').replace(',','.'))||0}
function pDate(s){if(!s)return null;s=s.trim().split(/[\sT]/)[0];let m=s.match(/^(\d{2})[.\/-](\d{2})[.\/-](\d{4})/);if(m)return`${m[3]}-${m[2]}-${m[1]}`;m=s.match(/^(\d{4})-(\d{2})-(\d{2})/);if(m)return s.slice(0,10);return null}

// ========== IMPORT FLOW ==========
function handleFile(file){const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'||ext==='tsv'){const rd=new FileReader();rd.onload=e=>{try{let t=e.target.result;if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);stageImport(parseCSV(t),file.name)}catch(err){toast('–û—à–∏–±–∫–∞: '+err.message,'err')}};rd.readAsText(file,'utf-8')}
  else if(ext==='xlsx'||ext==='xls'){const rd=new FileReader();rd.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array',raw:true});stageImport(parseCSV(XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]],{FS:';'})),file.name)}catch(err){toast('–û—à–∏–±–∫–∞: '+err.message,'err')}};rd.readAsArrayBuffer(file)}
  else toast('–§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è','err')}

function stageImport(raw,fname){
  if(!raw.length){toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö','warn');return}
  const impAcctId=$('impAcct')?.value||'';
  const keys=new Set(DB.ops.map(o=>`${o.d}|${o.a}|${o.cp}|${o.accountId||''}`));const fresh=raw.filter(o=>!keys.has(`${o.d}|${o.a}|${o.cp}|${impAcctId}`));const dupes=raw.length-fresh.length;
  pending=fresh.map(o=>{const r=resolveOp(o.cp,o.cm,o.dir);return{...o,t:r.t||o.dir,svcId:r.svcId,expTypeId:r.expTypeId,_src:r.source,_rem:r.source==='saved',_sel:false,_acctId:impAcctId}});
  const cn=t=>pending.filter(o=>o.t===t).length;const mapped=pending.filter(o=>o._src!=='none').length;
  $('impStats').innerHTML=`<div class="st"><span class="st-l">–§–∞–π–ª:</span><span class="st-v">${esc(fname)}</span></div><div class="st"><span class="st-l">–ù–æ–≤—ã—Ö:</span><span class="st-v">${pending.length}</span></div>${dupes?`<div class="st"><span class="st-l">–î—É–±–ª–∏:</span><span class="st-v">${dupes}</span></div>`:''}<div class="st"><span class="st-v pos">${cn('in')} –≤—Ö</span></div><div class="st"><span class="st-v neg">${cn('out')} —Ä–∞—Å—Ö</span></div>${cn('owner')?`<div class="st"><span class="st-v owner">${cn('owner')} –¥–∏–≤</span></div>`:''}${cn('internal')?`<div class="st"><span class="st-v intxfer">${cn('internal')} –≤–Ω</span></div>`:''}<div class="st"><span class="st-l">–†–∞–∑–º–µ—á–µ–Ω–æ:</span><span class="st-v">${mapped}/${pending.length}</span></div>`;
  $('impInfo').textContent=(pending.length-mapped)?`‚ö†Ô∏è ${pending.length-mapped} –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏`:'‚úÖ –í—Å–µ —Ä–∞–∑–º–µ—á–µ–Ω—ã';
  curFlt='all';renderImpTable();$('impArea').style.display='block';$('impArea').scrollIntoView({behavior:'smooth'})}

function catOpts(type,selId){
  if(type==='in'||type==='transit'){return'<option value="">‚Äî –≤—ã–±–µ—Ä–∏ ‚Äî</option>'+REF.svcs.filter(s=>s.active).map(s=>`<option value="${s.id}"${s.id===selId?' selected':''}>${s.moneyType==='transit'?'üîÑ ':''}${s.name}</option>`).join('')}
  if(type==='out'){let h='<option value="">‚Äî –≤—ã–±–µ—Ä–∏ ‚Äî</option>';REF.expCats.filter(c=>c.active).forEach(c=>{const t=REF.expTypes.filter(t=>t.catId===c.id&&t.active);if(t.length){h+=`<optgroup label="${esc(c.name)}">${t.map(t=>`<option value="${t.id}"${t.id===selId?' selected':''}>${t.name}</option>`).join('')}</optgroup>`}});return h}
  return'<option value="">‚Äî –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî</option>'}

const TYPE_OPTS=['out','in','transit','owner','internal'].map(v=>`<option value="${v}">${OT[v].lbl}</option>`).join('');
let curFlt='all';

function renderImpTable(){
  const q=($('fltQ')?.value||'').toLowerCase();
  $('impBody').innerHTML=pending.map((o,i)=>{
    const vis=isVisible(o,q);const sel=o.t==='out'?o.expTypeId:(o.svcId||'');const cls=o._src==='saved'||o._src==='auto'?'auto':o._src==='manual'?'manual':'';const ot=OT[o.t]||OT.out;
    return`<tr${vis?'':' class="hidden"'}>
      <td class="c-cb"><input type="checkbox" data-i="${i}" ${o._sel?'checked':''} onchange="onSelRow(${i},this.checked)"></td>
      <td class="c-date mono">${o.d}</td><td class="c-dir" style="color:${ot.color}">${ot.icon}</td>
      <td class="c-amt mono" style="color:${ot.color}">${o.t==='out'||o.t==='owner'?'‚àí':'+'}${fmt(o.a)}</td>
      <td class="c-desc">${esc(o.cm||'‚Äî')}</td><td class="c-cp">${esc(o.cp||'‚Äî')}</td>
      <td><select class="tsel" data-i="${i}" data-f="type" onchange="onImpType(this)">${TYPE_OPTS.replace('value="'+o.t+'"','value="'+o.t+'" selected')}</select></td>
      <td><select class="tsel ${cls}" data-i="${i}" data-f="cat" onchange="onImpCat(this)">${catOpts(o.t,sel)}</select></td>
      <td style="text-align:center"><label class="rem-cb"><input type="checkbox" data-i="${i}" data-r="1" ${o._rem?'checked':''}> ‚úì</label></td>
    </tr>`}).join('');
  updateBulk()}

function isVisible(o,q){
  if(curFlt==='nocat'){const has=o.t==='owner'||o.t==='internal'||(o.t==='out'?!!o.expTypeId:!!o.svcId);if(has)return false}
  if(curFlt==='out'&&o.t!=='out')return false;if(curFlt==='in'&&o.t!=='in'&&o.t!=='transit')return false;
  if(q&&!(o.cm||'').toLowerCase().includes(q)&&!(o.cp||'').toLowerCase().includes(q))return false;
  return true}
function setFlt(btn){document.querySelectorAll('.flt-pill').forEach(b=>b.classList.remove('on'));btn.classList.add('on');curFlt=btn.dataset.ft;renderImpTable()}
function applyFilters(){renderImpTable()}

// Bulk select
function onSelRow(i,checked){pending[i]._sel=checked;updateBulk()}
function toggleAll(checked){pending.forEach(o=>o._sel=checked);renderImpTable()}
function updateBulk(){const cnt=pending.filter(o=>o._sel).length;$('bulkCnt').textContent=cnt+' –≤—ã–±—Ä–∞–Ω–æ';$('bulkBar').classList.toggle('show',cnt>0);if(cnt>0){const first=pending.find(o=>o._sel);$('bulkCat').innerHTML='<option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí</option>'+catOpts(first?.t||'out','').replace('<option value="">‚Äî –≤—ã–±–µ—Ä–∏ ‚Äî</option>','')}}
function bulkSetType(){const v=$('bulkType').value;if(!v)return;pending.forEach(o=>{if(o._sel){o.t=v;o.svcId=null;o.expTypeId=null;o._src='manual'}});$('bulkType').value='';renderImpTable();toast(`–¢–∏–ø ‚Üí ${OT[v].lbl}`)}
function bulkSetCat(){const v=$('bulkCat').value;if(!v)return;pending.forEach(o=>{if(o._sel){if(o.t==='out')o.expTypeId=v;else o.svcId=v;o._src='manual'}});$('bulkCat').value='';renderImpTable();toast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞')}

function onImpType(sel){const i=+sel.dataset.i;pending[i].t=sel.value;pending[i].svcId=null;pending[i].expTypeId=null;pending[i]._src='manual';renderImpTable()}
function onImpCat(sel){const i=+sel.dataset.i;const v=sel.value;if(pending[i].t==='out')pending[i].expTypeId=v;else pending[i].svcId=v;pending[i]._src=v?'manual':'none';sel.className='tsel'+(v?' manual':'')}
function autoMapAll(){pending.forEach(o=>{if(o.t==='owner'||o.t==='internal')return;const has=o.t==='out'?o.expTypeId:o.svcId;if(!has){const r=resolveOp(o.cp,o.cm,o.t);if(r.source!=='none'){o.t=r.t||o.t;o.svcId=r.svcId;o.expTypeId=r.expTypeId;o._src=r.source}}});renderImpTable();const un=pending.filter(o=>{if(o.t==='owner'||o.t==='internal')return false;return o.t==='out'?!o.expTypeId:!o.svcId}).length;toast(un?`–û—Å—Ç–∞–ª–æ—Å—å ${un} –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏`:'–í—Å—ë —Ä–∞–∑–º–µ—á–µ–Ω–æ!')}

function confirmImport(){
  const unmapped=pending.filter(o=>{if(o.t==='owner'||o.t==='internal')return false;return o.t==='out'?!o.expTypeId:!o.svcId});
  if(unmapped.length&&!confirm(`${unmapped.length} –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`))return;
  document.querySelectorAll('#impBody input[data-r]').forEach(cb=>{if(cb.checked){const i=+cb.dataset.i;const o=pending[i];const key=normCp(o.cp);if(key)cpMap[key]={t:o.t,svcId:o.svcId||null,expTypeId:o.expTypeId||null}}});
  if($('bulkRem').checked){pending.forEach(o=>{const key=normCp(o.cp);if(key&&(o.svcId||o.expTypeId))cpMap[key]={t:o.t,svcId:o.svcId||null,expTypeId:o.expTypeId||null}})}
  const ops=pending.map(o=>({d:o.d,a:o.a,t:o.t,svcId:o.svcId||null,expTypeId:o.expTypeId||null,cp:o.cp,cm:o.cm,accountId:o._acctId||null}));
  DB.ops.push(...ops);DB.ops.sort((a,b)=>a.d.localeCompare(b.d));save();toast(`‚úÖ ${ops.length} –æ–ø–µ—Ä–∞—Ü–∏–π`);pending=[];$('impArea').style.display='none';renderAll()}
function cancelImport(){pending=[];$('impArea').style.display='none'}

// ========== MANUAL ENTRY ==========
function onMTypeChange(){const t=$('mType').value;const w=$('mCatWrap');if(t==='owner'||t==='internal'){w.style.display='none';return}w.style.display='';$('mCatLabel').textContent=t==='out'?'–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞':'–í–∏–¥ —É—Å–ª—É–≥–∏';$('mCat').innerHTML=catOpts(t,'')}
function addManual(){
  const date=$('mDate').value,type=$('mType').value,amt=parseFloat($('mAmt').value);
  if(!date){toast('–î–∞—Ç–∞','err');return}if(!amt||amt<=0){toast('–°—É–º–º–∞','err');return}
  const op={d:date,a:amt,t:type,cp:$('mCp').value.trim(),cm:$('mCm').value.trim(),svcId:null,expTypeId:null};
  if(type==='out'){op.expTypeId=$('mCat').value||null;if(!op.expTypeId){toast('–í—ã–±–µ—Ä–∏ –≤–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞','err');return}}
  else if(type==='in'||type==='transit'){op.svcId=$('mCat').value||null;if(!op.svcId){toast('–í—ã–±–µ—Ä–∏ –≤–∏–¥ —É—Å–ª—É–≥–∏','err');return}const svc=REF.svcs.find(s=>s.id===op.svcId);if(svc?.moneyType==='transit')op.t='transit'}
  DB.ops.push(op);DB.ops.sort((a,b)=>a.d.localeCompare(b.d));save();toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');$('mAmt').value='';$('mCp').value='';$('mCm').value='';renderAll()}

function renderRecent(){
  const last=DB.ops.slice(-20).reverse();const el=$('recentOps');
  if(!last.length){el.innerHTML=`<div class="empty"><div class="ei">üì≠</div><div class="et">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div><div class="cta" onclick="goTab('imp')">‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É</div></div>`;return}
  el.innerHTML=last.map((o,idx)=>{const ri=DB.ops.length-1-idx;const ot=OT[o.t]||OT.out;
    const acctLabel=o.accountId?acctName(o.accountId):'';
    return`<div class="rop"><div class="rop-bar" style="background:${ot.color}"></div><span class="mono" style="color:var(--mt)">${o.d}</span><span style="color:${ot.color}">${ot.icon}</span><span class="mono" style="color:${ot.color};text-align:right">${o.t==='out'||o.t==='owner'?'‚àí':'+'}${fmt(o.a)}</span><span style="font-weight:600">${esc(opLabel(o))}</span><span style="color:var(--mt)">${esc(o.cp||o.cm||'‚Äî')}${acctLabel?' <span style="font-size:9px;opacity:.6">¬∑ '+esc(acctLabel)+'</span>':''}</span><span style="display:flex;gap:4px"><button class="btn btn-o" style="padding:2px 6px;font-size:9px" onclick="editOp(${ri})">‚úé</button><button class="btn btn-d" style="padding:2px 6px;font-size:9px" onclick="delOp(${ri})">‚úï</button></span></div>`}).join('')}
function delOp(i){DB.ops.splice(i,1);save();renderAll();toast('–£–¥–∞–ª–µ–Ω–æ')}

// ========== EDIT OPERATION ==========
function editOp(i){
  const o=DB.ops[i];if(!o)return;
  const typeOpts=['out','in','transit','owner','internal'].map(v=>`<option value="${v}"${v===o.t?' selected':''}>${OT[v].lbl}</option>`).join('');
  const catSel=catOpts(o.t,o.t==='out'?o.expTypeId:o.svcId);
  const acctOptions=FP.accounts.filter(a=>a.active).map(a=>{const c=acctCat(a.catId);return`<option value="${a.id}"${a.id===o.accountId?' selected':''}>${c?c.icon+' ':''}${a.name}</option>`}).join('');
  showModal(`<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</h3>
    <div class="form-row">
      <div class="form-g" style="margin-bottom:10px"><label>–î–∞—Ç–∞</label><input type="date" id="_ed" value="${o.d}"></div>
      <div class="form-g" style="margin-bottom:10px"><label>–¢–∏–ø</label><select id="_et" onchange="onEditTypeChange()">${typeOpts}</select></div>
      <div class="form-g" style="margin-bottom:10px"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" id="_ea" value="${o.a}" min="0" step="100"></div>
    </div>
    <div class="form-row">
      <div class="form-g" id="_ecWrap" style="margin-bottom:10px"><label id="_ecLabel">${o.t==='out'?'–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞':'–í–∏–¥ —É—Å–ª—É–≥–∏'}</label><select id="_ec">${catSel}</select></div>
      <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label><input id="_ecp" value="${esc(o.cp||'')}"></div>
      <div class="form-g" style="margin-bottom:10px"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input id="_ecm" value="${esc(o.cm||'')}"></div>
    </div>
    <div class="form-g" style="margin-bottom:10px"><label>–°—á—ë—Ç</label><select id="_eAcct"><option value="">‚Äî –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ ‚Äî</option>${acctOptions}</select></div>
    <div class="btn-grp"><button class="btn btn-p" onclick="saveOp(${i})">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`)
}
function onEditTypeChange(){const t=$('_et').value;const w=$('_ecWrap');if(t==='owner'||t==='internal'){w.style.display='none';return}w.style.display='';$('_ecLabel').textContent=t==='out'?'–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞':'–í–∏–¥ —É—Å–ª—É–≥–∏';$('_ec').innerHTML=catOpts(t,'')}
function saveOp(i){
  const o=DB.ops[i];if(!o)return;
  const d=$('_ed').value,t=$('_et').value,a=parseFloat($('_ea').value);
  if(!d){toast('–î–∞—Ç–∞','err');return}if(!a||a<=0){toast('–°—É–º–º–∞','err');return}
  o.d=d;o.t=t;o.a=a;o.cp=$('_ecp').value.trim();o.cm=$('_ecm').value.trim();o.accountId=$('_eAcct').value||null;
  if(t==='out'){o.expTypeId=$('_ec').value||null;o.svcId=null}
  else if(t==='in'||t==='transit'){o.svcId=$('_ec').value||null;o.expTypeId=null;const svc=REF.svcs.find(s=>s.id===o.svcId);if(svc?.moneyType==='transit')o.t='transit'}
  else{o.svcId=null;o.expTypeId=null}
  DB.ops.sort((a,b)=>a.d.localeCompare(b.d));save();renderAll();closeModal();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
}

// ========== EXPORT / IMPORT BACKUP ==========
async function exportBackup(){
  try {
    let data;
    if (DEMO_MODE) {
      data = { DB, REF, cpMap, rules, FP, exportedAt: new Date().toISOString() };
    } else {
      data = await api('GET', '/api/backup');
    }
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`fintablo-backup-${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);
    toast('–ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω')
  } catch(e) { toast('–û—à–∏–±–∫–∞: '+e.message,'err') }
}
async function importBackup(file){
  if(!file)return;
  const rd=new FileReader();
  rd.onload=async e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.DB&&!data.REF){toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±—ç–∫–∞–ø–∞','err');return}
      const _DB = data.DB || data.data?.DB;
      const _REF = data.REF || data.data?.REF;
      if(!_DB||!_REF){toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç','err');return}
      if(!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –±—ç–∫–∞–ø –æ—Ç ${data.exportedAt?.slice(0,10)||'?'}?\n–û–ø–µ—Ä–∞—Ü–∏–∏: ${_DB.ops?.length||0}\n‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ó–ê–ú–ï–ù–ï–ù–´.`))return;
      if (DEMO_MODE) {
        DB=_DB;REF=_REF;cpMap=data.cpMap||{};rules=data.rules||[];FP=data.FP||{};
        if(!FP.obligations)FP.obligations=[];
        migrateObligations();
        save();
      } else {
        await api('POST', '/api/backup', { DB: _DB, REF: _REF, cpMap: data.cpMap||{}, rules: data.rules||[], FP: data.FP||{} });
        await loadFromServer();
      }
      initRefs();
      renderAll();if(screen==='fp')renderFP();
      toast(`‚úÖ –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω: ${_DB.ops?.length||0} –æ–ø–µ—Ä–∞—Ü–∏–π`)
    }catch(err){toast('–û—à–∏–±–∫–∞: '+err.message,'err')}
  };
  rd.readAsText(file);$('_backupInp').value=''
}

// ========== POPULATE IMPORT ACCOUNT SELECTOR ==========
function populateImpAcct(){
  const sel=$('impAcct');if(!sel)return;
  const accts=FP.accounts.filter(a=>a.active);
  sel.innerHTML='<option value="">‚Äî –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ (–æ–±—â–∏–π) ‚Äî</option>'+accts.map(a=>{const c=acctCat(a.catId);return`<option value="${a.id}">${c?c.icon+' ':''}${a.name}</option>`}).join('')
}

// ========== REFERENCE CRUD ==========
function renderRef(){
  document.querySelector('#tblIncCat tbody').innerHTML=REF.incCats.map((c,i)=>`<tr class="${c.active?'':'inactive'}"><td><strong>${esc(c.name)}</strong></td><td style="color:var(--tx2);font-size:11px">${esc(c.desc)}</td><td>${c.active?'<span class="tag tag-in">–ê–∫—Ç</span>':'<span class="tag tag-off">–í—ã–∫–ª</span>'}</td><td style="width:100px"><button class="btn btn-o" style="font-size:10px;padding:3px 8px" onclick="editRef('incCats',${i})">‚úé</button> <button class="btn btn-d" style="padding:3px 8px;font-size:10px" onclick="togRef('incCats',${i})">${c.active?'–í—ã–∫–ª':'–í–∫–ª'}</button></td></tr>`).join('');
  document.querySelector('#tblSvc tbody').innerHTML=REF.svcs.map((s,i)=>`<tr class="${s.active?'':'inactive'}"><td><strong>${esc(s.name)}</strong></td><td style="font-size:11px">${s.catId?nm(REF.incCats,s.catId):'‚Äî'}</td><td>${s.moneyType==='transit'?'<span class="tag tag-tr">transit</span>':'<span class="tag tag-in">income</span>'}</td><td>${s.active?'<span class="tag tag-in">–ê–∫—Ç</span>':'<span class="tag tag-off">–í—ã–∫–ª</span>'}</td><td style="width:100px"><button class="btn btn-o" style="font-size:10px;padding:3px 8px" onclick="editRef('svcs',${i})">‚úé</button> <button class="btn btn-d" style="padding:3px 8px;font-size:10px" onclick="togRef('svcs',${i})">${s.active?'–í—ã–∫–ª':'–í–∫–ª'}</button></td></tr>`).join('');
  document.querySelector('#tblExpCat tbody').innerHTML=REF.expCats.map((c,i)=>`<tr class="${c.active?'':'inactive'}"><td><strong>${esc(c.name)}</strong></td><td style="color:var(--tx2);font-size:11px">${esc(c.desc)}</td><td>${c.active?'<span class="tag tag-in">–ê–∫—Ç</span>':'<span class="tag tag-off">–í—ã–∫–ª</span>'}</td><td style="width:100px"><button class="btn btn-o" style="font-size:10px;padding:3px 8px" onclick="editRef('expCats',${i})">‚úé</button> <button class="btn btn-d" style="padding:3px 8px;font-size:10px" onclick="togRef('expCats',${i})">${c.active?'–í—ã–∫–ª':'–í–∫–ª'}</button></td></tr>`).join('');
  document.querySelector('#tblExpType tbody').innerHTML=REF.expTypes.map((t,i)=>`<tr class="${t.active?'':'inactive'}"><td><strong>${esc(t.name)}</strong></td><td style="font-size:11px">${t.catId?nm(REF.expCats,t.catId):'‚Äî'}</td><td>${t.active?'<span class="tag tag-in">–ê–∫—Ç</span>':'<span class="tag tag-off">–í—ã–∫–ª</span>'}</td><td style="width:100px"><button class="btn btn-o" style="font-size:10px;padding:3px 8px" onclick="editRef('expTypes',${i})">‚úé</button> <button class="btn btn-d" style="padding:3px 8px;font-size:10px" onclick="togRef('expTypes',${i})">${t.active?'–í—ã–∫–ª':'–í–∫–ª'}</button></td></tr>`).join('')}
function togRef(col,i){REF[col][i].active=!REF[col][i].active;save();renderRef()}
function editRef(col,i){const item=REF[col][i];let ex='';
  if(col==='svcs')ex=`<div class="form-g" style="margin-bottom:10px"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞</label><select id="_mc"><option value="">‚Äî —Ç—Ä–∞–Ω–∑–∏—Ç ‚Äî</option>${REF.incCats.map(c=>`<option value="${c.id}"${c.id===item.catId?' selected':''}>${c.name}</option>`).join('')}</select></div><div class="form-g" style="margin-bottom:10px"><label>–¢–∏–ø –¥–µ–Ω–µ–≥</label><select id="_mt"><option value="income"${item.moneyType==='income'?' selected':''}>income</option><option value="transit"${item.moneyType==='transit'?' selected':''}>transit</option></select></div>`;
  if(col==='expTypes')ex=`<div class="form-g" style="margin-bottom:10px"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞</label><select id="_mc">${REF.expCats.map(c=>`<option value="${c.id}"${c.id===item.catId?' selected':''}>${c.name}</option>`).join('')}</select></div>`;
  showModal(`<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3><div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_mn" value="${esc(item.name)}"></div>${item.desc!==undefined?`<div class="form-g" style="margin-bottom:10px"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input id="_md" value="${esc(item.desc||'')}"></div>`:''}${ex}<div class="btn-grp"><button class="btn btn-p" onclick="saveEdit('${col}',${i})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`)}
function saveEdit(col,i){REF[col][i].name=$('_mn').value;const md=$('_md');if(md&&REF[col][i].desc!==undefined)REF[col][i].desc=md.value;if(col==='svcs'){REF[col][i].catId=$('_mc').value||null;REF[col][i].moneyType=$('_mt').value}if(col==='expTypes')REF[col][i].catId=$('_mc').value;save();renderRef();closeModal();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}
function openAddModal(type){
  if(type==='svc')showModal(`<h3>–ù–æ–≤—ã–π –≤–∏–¥ —É—Å–ª—É–≥–∏</h3><div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_mn"></div><div class="form-g" style="margin-bottom:10px"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞</label><select id="_mc"><option value="">‚Äî —Ç—Ä–∞–Ω–∑–∏—Ç ‚Äî</option>${REF.incCats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div><div class="form-g" style="margin-bottom:10px"><label>–¢–∏–ø –¥–µ–Ω–µ–≥</label><select id="_mt"><option value="income">income</option><option value="transit">transit</option></select></div><div class="btn-grp"><button class="btn btn-p" onclick="addRefItem('svcs')">–î–æ–±–∞–≤–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`);
  else showModal(`<h3>–ù–æ–≤—ã–π –≤–∏–¥ —Ä–∞—Å—Ö–æ–¥–∞</h3><div class="form-g" style="margin-bottom:10px"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="_mn"></div><div class="form-g" style="margin-bottom:10px"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞</label><select id="_mc">${REF.expCats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div><div class="btn-grp"><button class="btn btn-p" onclick="addRefItem('expTypes')">–î–æ–±–∞–≤–∏—Ç—å</button><button class="btn btn-o" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`)}
function addRefItem(col){const name=$('_mn').value.trim();if(!name){toast('–ù–∞–∑–≤–∞–Ω–∏–µ','err');return}const item={id:uid(),name,active:true};if(col==='svcs'){item.desc='';item.catId=$('_mc').value||null;item.moneyType=$('_mt').value}if(col==='expTypes')item.catId=$('_mc').value;REF[col].push(item);save();renderRef();closeModal();toast('–î–æ–±–∞–≤–ª–µ–Ω–æ')}
function showModal(html){$('modalWrap').innerHTML=`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal">${html}</div></div>`}
function closeModal(){$('modalWrap').innerHTML=''}

// ========== RULES & MAP ==========
function renderSavedMap(){const entries=Object.entries(cpMap);const el=$('savedMapList');
  if(!entries.length){el.innerHTML='<div style="color:var(--mt);font-size:11px;padding:8px">–°—Ç–∞–≤—å ‚úì¬´–ó–∞–ø.¬ª –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ.</div>';return}
  el.innerHTML=entries.map(([key,val])=>{const tl=(OT[val.t]||OT.out).lbl;const cl=val.svcId?nm(REF.svcs,val.svcId):(val.expTypeId?nm(REF.expTypes,val.expTypeId):'‚Äî');
    return`<div class="smap-row"><div class="smap-from">${esc(key)}</div><div class="smap-arr">‚Üí</div><div class="smap-to">${tl}</div><div class="smap-to">${esc(cl)}</div><button class="btn btn-d" style="padding:3px 6px;font-size:9px" onclick="delete cpMap[${JSON.stringify(key)}];save();renderSavedMap()">‚úï</button></div>`}).join('')}

function renderRules(){
  // Build options: expense types + income services + special
  let opts='<optgroup label="‚Äî –°–ø–µ—Ü—Ç–∏–ø—ã ‚Äî"><option value="_owner" data-d="out">üí∏ –î–∏–≤–∏–¥–µ–Ω–¥—ã</option><option value="_internal" data-d="out">‚ÜîÔ∏è –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥</option></optgroup>';
  opts+='<optgroup label="‚Äî –î–æ—Ö–æ–¥—ã / –£—Å–ª—É–≥–∏ ‚Äî">';REF.svcs.filter(s=>s.active).forEach(s=>{opts+=`<option value="${s.id}" data-d="in">${s.moneyType==='transit'?'üîÑ ':'üì• '}${s.name}</option>`});opts+='</optgroup>';
  REF.expCats.filter(c=>c.active).forEach(c=>{const types=REF.expTypes.filter(t=>t.catId===c.id&&t.active);if(types.length){opts+=`<optgroup label="üì§ ${esc(c.name)}">${types.map(t=>`<option value="${t.id}" data-d="out">${t.name}</option>`).join('')}</optgroup>`}});
  document.querySelector('#rulesTable tbody').innerHTML=rules.map((r,i)=>`<tr><td style="width:42%"><input class="rinp mono" value="${esc(r.p)}" data-i="${i}" data-f="p" placeholder="regex"></td><td style="width:10px;color:var(--mt);text-align:center">‚Üí</td><td><select class="rinp" data-i="${i}" data-f="c" style="font-family:'Inter',sans-serif">${opts.replace('value="'+r.c+'"','value="'+r.c+'" selected')}</select></td><td style="width:28px"><button class="btn btn-d" style="padding:3px 6px;font-size:9px" onclick="rules.splice(${i},1);save();renderRules()">‚úï</button></td></tr>`).join('')}
function addRule(){rules.push({p:'',c:REF.expTypes[0]?.id||'',d:'out'});renderRules()}
function saveRules(){document.querySelectorAll('#rulesTable [data-i]').forEach(el=>{const i=+el.dataset.i;if(el.dataset.f==='p')rules[i].p=el.value;if(el.dataset.f==='c'){rules[i].c=el.value;const opt=el.selectedOptions[0];rules[i].d=opt?.dataset?.d||'out'}});save();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}
function saveBal(){toast('–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É ¬´–ù–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏¬ª –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ü–æ–∑–∏—Ü–∏—è','warn')}

// ========== NAV ==========
document.querySelectorAll('.nav-t').forEach(t=>{t.addEventListener('click',()=>goTab(t.dataset.s))});
document.querySelectorAll('.pill').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.pill').forEach(x=>x.classList.remove('on'));b.classList.add('on');period=b.dataset.p;renderPeriod();renderAll()})});
const dropZ=$('dropZ'),fInp=$('fInp');
dropZ.addEventListener('click',()=>fInp.click());fInp.addEventListener('change',e=>{if(e.target.files[0])handleFile(e.target.files[0])});
dropZ.addEventListener('dragover',e=>{e.preventDefault();dropZ.classList.add('over')});dropZ.addEventListener('dragleave',()=>dropZ.classList.remove('over'));
dropZ.addEventListener('drop',e=>{e.preventDefault();dropZ.classList.remove('over');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0])});

// ========== INIT ==========
async function bootApp() {
  try {
    await loadFromServer();
    initRefs();
    if (!DB.ops.length) loadDemo();
    // Save initial data
    if (DB.ops.length) {
      if (DEMO_MODE) { save(); } else { await api('PUT', '/api/data', { data: { DB, REF, cpMap, rules, FP } }); }
    }
    $('authScreen').classList.add('hidden');
    $('appWrap').style.display = '';
    $('usrName').textContent = DEMO_MODE ? 'üöÄ –î–µ–º–æ' : (CURRENT_USER?.name || CURRENT_USER?.email || '‚Äî');
    $('mDate').value = new Date().toISOString().slice(0,10);
    onMTypeChange();
    renderPeriod();
    renderAll();
  } catch (e) {
    console.error('Boot failed:', e);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'err');
    doLogout();
  }
}

async function fullReset() {
  if (!confirm('–ü–û–õ–ù–´–ô –°–ë–†–û–°? –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
  DB = { ops: [], bal: 0 };
  REF = { incCats: [], svcs: [], expCats: [], expTypes: [] };
  cpMap = {};
  rules = [];
  FP = { assets: [], liabilities: [], openBal: [], clientObl: [], obligations: [], accounts: [] };
  if (DEMO_MODE) { localStorage.removeItem('ft5_demo'); } else { await api('PUT', '/api/data', { data: { DB, REF, cpMap, rules, FP } }); }
  initRefs();
  renderAll();
  toast('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
}

// Try auto-login on page load
(async () => {
  load(); // set defaults
  initRefs();
  if (AUTH_TOKEN) {
    try {
      const { user } = await api('GET', '/api/auth/me');
      CURRENT_USER = user;
      await bootApp();
    } catch (e) {
      clearToken();
      // Stay on auth screen
    }
  }
  // Auth screen is shown by default
})();

$('mDate').value = new Date().toISOString().slice(0,10);
onMTypeChange();
renderPeriod();

function loadDemo(){
  DB.bal=0; // legacy, replaced by FP.openBal

  // Opening balances ‚Äî initial state on 01.01.2026
  FP.openBal=[
    {id:'ob1',type:'account',name:'–¢–æ—á–∫–∞ —Ä/—Å –æ—Å–Ω–æ–≤–Ω–æ–π',amount:320000,comment:'–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ 01.01.2026',active:true,createdAt:'2026-01-01T00:00:00Z'},
    {id:'ob2',type:'card',name:'–¢–∏–Ω—å–∫–æ—Ñ—Ñ –±–∏–∑–Ω–µ—Å-–∫–∞—Ä—Ç–∞',amount:65000,comment:'–õ–∏–º–∏—Ç –Ω–∞ —Ö–æ–∑. —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ 01.01',active:true,createdAt:'2026-01-01T00:00:00Z'},
    {id:'ob3',type:'service',name:'–ë–∞–ª–∞–Ω—Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç',amount:35000,comment:'–û—Å—Ç–∞—Ç–æ–∫ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞',active:true,createdAt:'2026-01-01T00:00:00Z'},
  ];

  // === –Ø–ù–í–ê–†–¨ 2026 ‚Äî –ø–æ–ª–Ω—ã–π –º–µ—Å—è—Ü ===
  const jan=[
    // –î–û–•–û–î–´
    {d:'2026-01-05',a:185000,t:'in',svcId:'s01',cp:'–û–û–û –°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä',cm:'–õ–∏–¥—ã –ö–¶ —è–Ω–≤–∞—Ä—å'},
    {d:'2026-01-07',a:92000,t:'in',svcId:'s03',cp:'–ò–ü –ö–æ–∑–ª–æ–≤',cm:'–§–∏–∫—Å—Ü–µ–Ω–∞ –ø–∞–∫–µ—Ç 50 –ª–∏–¥–æ–≤'},
    {d:'2026-01-10',a:340000,t:'in',svcId:'s01',cp:'–ê–û –¢–µ–ø–ª–æ–î–æ–º',cm:'–õ–∏–¥—ã –ö–¶ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç'},
    {d:'2026-01-12',a:75000,t:'in',svcId:'s04',cp:'–û–û–û –§–∞—Ä–º–∞+',cm:'–ò–ò-–û–ö–ö –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ'},
    {d:'2026-01-14',a:45000,t:'in',svcId:'s05',cp:'–û–û–û –§–∞—Ä–º–∞+',cm:'–ò–ò-–û–ö–ö –∞–±–æ–Ω–µ–Ω—Ç–∫–∞ —è–Ω–≤–∞—Ä—å'},
    {d:'2026-01-16',a:120000,t:'in',svcId:'s06',cp:'–û–û–û –õ–æ–≥–∏—Å—Ç–∏–∫',cm:'–ò–ò-–ö–¶ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ'},
    {d:'2026-01-19',a:55000,t:'in',svcId:'s02',cp:'–û–û–û –ë—Ä–µ–Ω–¥–§–æ—Ä—Å',cm:'–ë—Ä–µ–Ω–¥–æ–≤—ã–µ –ª–∏–¥—ã'},
    {d:'2026-01-21',a:28000,t:'in',svcId:'s08',cp:'–û–û–û –õ–æ–≥–∏—Å—Ç–∏–∫',cm:'–ò–ò-–ö–¶ –∞–±–æ–Ω–µ–Ω—Ç–∫–∞'},
    {d:'2026-01-23',a:180000,t:'in',svcId:'s09',cp:'–ü–∞—Ä—Ç–Ω—ë—Ä –ê–ª—å—Ñ–∞',cm:'–ê–≥–µ–Ω—Ç—Å–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è Q4'},
    {d:'2026-01-27',a:12500,t:'in',svcId:'s10',cp:'–¢–æ—á–∫–∞ –±–∞–Ω–∫',cm:'–ö–µ—à–±–µ–∫ –∑–∞ –¥–µ–∫–∞–±—Ä—å'},
    {d:'2026-01-30',a:35000,t:'in',svcId:'s07',cp:'–ò–ü –í–∞—Å–∏–ª—å–µ–≤',cm:'–ù–µ–π—Ä–æ–ø—Ä–æ–¥–∞–≤–µ—Ü –ø–∏–ª–æ—Ç'},

    // –¢–†–ê–ù–ó–ò–¢
    {d:'2026-01-08',a:280000,t:'transit',svcId:'s12',cp:'–û–û–û –°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä',cm:'–†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞'},
    {d:'2026-01-20',a:150000,t:'transit',svcId:'s12',cp:'–ê–û –¢–µ–ø–ª–æ–î–æ–º',cm:'–ë—é–¥–∂–µ—Ç –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç'},

    // –†–ê–°–•–û–î–´ ‚Äî –§–û–¢
    {d:'2026-01-10',a:210000,t:'out',expTypeId:'et01',cp:'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥-–æ—Ç–¥–µ–ª',cm:'–ó–ü –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ —è–Ω–≤–∞—Ä—å'},
    {d:'2026-01-10',a:85000,t:'out',expTypeId:'et02',cp:'–ò–ü –°–∏–¥–æ—Ä–æ–≤–∞',cm:'–ü–æ–¥—Ä—è–¥—á–∏–∫ —Ñ–∏–∫—Å—Ü–µ–Ω–∞'},
    {d:'2026-01-11',a:120000,t:'out',expTypeId:'et03',cp:'–ö–¶ –ü—Ä–æ–º–µ—Ç–µ–π',cm:'–ü–æ–¥—Ä—è–¥—á–∏–∫ –ö–¶ –ª–∏–¥—ã'},
    {d:'2026-01-15',a:45000,t:'out',expTypeId:'et04',cp:'–§—Ä–∏–ª–∞–Ω—Å –î–∏–∑–∞–π–Ω',cm:'–ê—É—Ç—Å–æ—Ä—Å –¥–∏–∑–∞–π–Ω–µ—Ä'},

    // –†–ê–°–•–û–î–´ ‚Äî –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
    {d:'2026-01-09',a:95000,t:'out',expTypeId:'et05',cp:'–Ø–Ω–¥–µ–∫—Å',cm:'–î–∏—Ä–µ–∫—Ç –Ω–∞—à –±—é–¥–∂–µ—Ç'},

    // –†–ê–°–•–û–î–´ ‚Äî –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    {d:'2026-01-05',a:18500,t:'out',expTypeId:'et06',cp:'PlanFix',cm:'–ü–æ–¥–ø–∏—Å–∫–∞ PlanFix'},
    {d:'2026-01-05',a:7200,t:'out',expTypeId:'et06',cp:'Wazzup',cm:'–ü–æ–¥–ø–∏—Å–∫–∞ Wazzup'},
    {d:'2026-01-05',a:4500,t:'out',expTypeId:'et07',cp:'OpenAI',cm:'API ChatGPT'},
    {d:'2026-01-06',a:15000,t:'out',expTypeId:'et08',cp:'–ë—É—Ö—Å–µ—Ä–≤–∏—Å',cm:'–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ'},

    // –†–ê–°–•–û–î–´ ‚Äî –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ
    {d:'2026-01-25',a:62000,t:'out',expTypeId:'et10',cp:'–§–ù–°',cm:'–£–°–ù –∞–≤–∞–Ω—Å'},
    {d:'2026-01-02',a:3800,t:'out',expTypeId:'et09',cp:'–¢–æ—á–∫–∞',cm:'–†–ö–û + —ç–∫–≤–∞–π—Ä–∏–Ω–≥'},

    // –†–ê–°–•–û–î–´ ‚Äî –ü—Ä–æ—á–∏–µ
    {d:'2026-01-17',a:25000,t:'out',expTypeId:'et14',cp:'–ö–æ—Ä–ø. —Ñ–æ–Ω–¥',cm:'–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ —è–Ω–≤–∞—Ä—å'},
    {d:'2026-01-28',a:8500,t:'out',expTypeId:'et18',cp:'–ö–ª–∏–µ–Ω—Ç –ò–≤–∞–Ω–æ–≤',cm:'–ö–æ—Å—è–∫: –∑–∞–¥–≤–æ–µ–Ω–∏–µ –ª–∏–¥–æ–≤'},

    // –î–ò–í–ò–î–ï–ù–î–´
    {d:'2026-01-31',a:150000,t:'owner',cp:'–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫',cm:'–î–∏–≤–∏–¥–µ–Ω–¥—ã —è–Ω–≤–∞—Ä—å'},
  ];

  // === –§–ï–í–†–ê–õ–¨ 2026 (–¥–æ 7 —Ñ–µ–≤—Ä–∞–ª—è) ===
  const feb=[
    // –î–û–•–û–î–´
    {d:'2026-02-02',a:195000,t:'in',svcId:'s01',cp:'–û–û–û –°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä',cm:'–õ–∏–¥—ã –ö–¶ —Ñ–µ–≤—Ä–∞–ª—å'},
    {d:'2026-02-03',a:88000,t:'in',svcId:'s03',cp:'–ò–ü –ö–æ–∑–ª–æ–≤',cm:'–§–∏–∫—Å—Ü–µ–Ω–∞ –ø–∞–∫–µ—Ç'},
    {d:'2026-02-04',a:290000,t:'in',svcId:'s01',cp:'–ê–û –¢–µ–ø–ª–æ–î–æ–º',cm:'–õ–∏–¥—ã –ö–¶ –æ—Å–Ω–æ–≤–Ω–æ–π'},
    {d:'2026-02-05',a:45000,t:'in',svcId:'s05',cp:'–û–û–û –§–∞—Ä–º–∞+',cm:'–ò–ò-–û–ö–ö –∞–±–æ–Ω–µ–Ω—Ç–∫–∞ —Ñ–µ–≤—Ä–∞–ª—å'},
    {d:'2026-02-05',a:28000,t:'in',svcId:'s08',cp:'–û–û–û –õ–æ–≥–∏—Å—Ç–∏–∫',cm:'–ò–ò-–ö–¶ –∞–±–æ–Ω–µ–Ω—Ç–∫–∞'},
    {d:'2026-02-06',a:62000,t:'in',svcId:'s02',cp:'–û–û–û –ë—Ä–µ–Ω–¥–§–æ—Ä—Å',cm:'–ë—Ä–µ–Ω–¥–æ–≤—ã–µ –ª–∏–¥—ã'},

    // ‚ö†Ô∏è –†–∞–∑–æ–≤–∞—è —Å–¥–µ–ª–∫–∞ ‚Äî –∫—Ä—É–ø–Ω–∞—è (—Ç—Ä–∏–≥–≥–µ—Ä–Ω—ë—Ç –∞–Ω–æ–º–∞–ª–∏—é –µ—Å–ª–∏ >30%)
    {d:'2026-02-03',a:350000,t:'in',svcId:'s09',cp:'–ü–∞—Ä—Ç–Ω—ë—Ä –ë–µ—Ç–∞',cm:'–ê–≥–µ–Ω—Ç—Å–∫–∞—è —Ä–∞–∑–æ–≤–∞—è –∑–∞ –ø—Ä–æ–µ–∫—Ç'},

    // –¢–†–ê–ù–ó–ò–¢
    {d:'2026-02-02',a:310000,t:'transit',svcId:'s12',cp:'–û–û–û –°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä',cm:'–ë—é–¥–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —Ñ–µ–≤—Ä–∞–ª—å'},

    // –†–ê–°–•–û–î–´ ‚Äî –§–û–¢ (–ø–æ–¥—Ä–æ—Å–ª–æ –Ω–∞ 35%+ ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä –∞–Ω–æ–º–∞–ª–∏–∏)
    {d:'2026-02-01',a:280000,t:'out',expTypeId:'et01',cp:'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥-–æ—Ç–¥–µ–ª',cm:'–ó–ü –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ —Ñ–µ–≤—Ä–∞–ª—å (—Ä–æ—Å—Ç —à—Ç–∞—Ç–∞)'},
    {d:'2026-02-01',a:85000,t:'out',expTypeId:'et02',cp:'–ò–ü –°–∏–¥–æ—Ä–æ–≤–∞',cm:'–ü–æ–¥—Ä—è–¥—á–∏–∫ —Ñ–∏–∫—Å—Ü–µ–Ω–∞'},
    {d:'2026-02-02',a:140000,t:'out',expTypeId:'et03',cp:'–ö–¶ –ü—Ä–æ–º–µ—Ç–µ–π',cm:'–ü–æ–¥—Ä—è–¥—á–∏–∫ –ö–¶ –ª–∏–¥—ã'},
    {d:'2026-02-03',a:45000,t:'out',expTypeId:'et04',cp:'–§—Ä–∏–ª–∞–Ω—Å –î–∏–∑–∞–π–Ω',cm:'–ê—É—Ç—Å–æ—Ä—Å –¥–∏–∑–∞–π–Ω–µ—Ä'},

    // –†–ê–°–•–û–î–´ ‚Äî –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
    {d:'2026-02-01',a:110000,t:'out',expTypeId:'et05',cp:'–Ø–Ω–¥–µ–∫—Å',cm:'–î–∏—Ä–µ–∫—Ç –Ω–∞—à'},

    // –†–ê–°–•–û–î–´ ‚Äî –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    {d:'2026-02-01',a:18500,t:'out',expTypeId:'et06',cp:'PlanFix',cm:'PlanFix —Ñ–µ–≤—Ä–∞–ª—å'},
    {d:'2026-02-01',a:7200,t:'out',expTypeId:'et06',cp:'Wazzup',cm:'Wazzup —Ñ–µ–≤—Ä–∞–ª—å'},
    {d:'2026-02-01',a:6800,t:'out',expTypeId:'et07',cp:'OpenAI',cm:'API —Ñ–µ–≤—Ä–∞–ª—å (—Ä–æ—Å—Ç usage)'},
    {d:'2026-02-02',a:15000,t:'out',expTypeId:'et08',cp:'–ë—É—Ö—Å–µ—Ä–≤–∏—Å',cm:'–ë—É—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ'},

    // –†–ê–°–•–û–î–´ ‚Äî –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ
    {d:'2026-02-05',a:4200,t:'out',expTypeId:'et09',cp:'–¢–æ—á–∫–∞',cm:'–†–ö–û —Ñ–µ–≤—Ä–∞–ª—å'},

    // –†–ê–°–•–û–î–´ ‚Äî –ü—Ä–æ—á–∏–µ (>10% ‚Üí –∞–Ω–æ–º–∞–ª–∏—è)
    {d:'2026-02-04',a:50000,t:'out',expTypeId:'et15',cp:'–†–µ–∑–µ—Ä–≤',cm:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞'},
    {d:'2026-02-06',a:42000,t:'out',expTypeId:'et16',cp:'–ö–ª–∏–µ–Ω—Ç –ü–µ—Ç—Ä–æ–≤',cm:'–í–æ–∑–≤—Ä–∞—Ç –∑–∞ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏–¥—ã'},
    {d:'2026-02-06',a:15000,t:'out',expTypeId:'et18',cp:'–ü–æ–¥—Ä—è–¥—á–∏–∫',cm:'–ö–æ—Å—è–∫: –Ω–µ–≤–µ—Ä–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏'},

    // –í–ù–£–¢–†–ï–ù–ù–ò–ô –ü–ï–†–ï–í–û–î
    {d:'2026-02-04',a:100000,t:'internal',cp:'–ú–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏',cm:'–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π'},
  ];

  DB.ops=[...jan,...feb].map(o=>({d:o.d,a:o.a,t:o.t,svcId:o.svcId||null,expTypeId:o.expTypeId||null,cp:o.cp||'',cm:o.cm||''}));
  DB.ops.sort((a,b)=>a.d.localeCompare(b.d));

  // Financial Position ‚Äî demo entries
  FP.assets=[
    {id:'da1',type:'card',name:'–¢–∏–Ω—å–∫–æ—Ñ—Ñ –±–∏–∑–Ω–µ—Å-–∫–∞—Ä—Ç–∞',amount:85000,confidence:'exact',comment:'–õ–∏–º–∏—Ç –Ω–∞ —Ö–æ–∑. —Ä–∞—Å—Ö–æ–¥—ã',active:true,updatedAt:'2026-02-07T10:00:00Z'},
    {id:'da2',type:'service',name:'–ë–∞–ª–∞–Ω—Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Ä–µ–∫—Ç',amount:42000,confidence:'estimate',comment:'–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ',active:true,updatedAt:'2026-02-07T10:00:00Z'},
    {id:'da3',type:'reserve',name:'–†–µ–∑–µ—Ä–≤–Ω—ã–π —Ñ–æ–Ω–¥ (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π)',amount:200000,confidence:'exact',comment:'–û—Ç–¥–µ–ª—å–Ω—ã–π —Å—á—ë—Ç',active:true,updatedAt:'2026-02-07T10:00:00Z'},
  ];
  FP.liabilities=[
    {id:'dl1',type:'transit',name:'–†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä',amount:310000,confidence:'exact',comment:'–ü—Ä–∏—à—ë–ª 02.02, –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—É—á–µ–Ω',active:true,updatedAt:'2026-02-07T10:00:00Z'},
    {id:'dl2',type:'accrued',name:'–ó–ü –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤ (–Ω–∞—á–∏—Å–ª–µ–Ω–æ)',amount:65000,confidence:'estimate',comment:'–ê–∫—Ç—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã, –æ–ø–ª–∞—Ç–∞ –¥–æ 10.02',active:true,updatedAt:'2026-02-07T10:00:00Z'},
    {id:'dl3',type:'other',name:'–®—Ç—Ä–∞—Ñ –§–ê–° (–æ—Å–ø–∞—Ä–∏–≤–∞–µ—Ç—Å—è)',amount:25000,confidence:'estimate',comment:'–ñ–∞–ª–æ–±–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ',active:true,updatedAt:'2026-02-07T10:00:00Z'},
  ];

  // Client obligations ‚Äî aggregated by product category
  FP.clientObl=[
    {id:'co1',svcId:'s01',amount:280000,confidence:'estimate',comment:'–°–æ–≤–æ–∫—É–ø–Ω—ã–µ –∞–≤–∞–Ω—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ –ª–∏–¥—ã –ö–¶ (3 –∫–ª–∏–µ–Ω—Ç–∞)',active:true,updatedAt:'2026-02-07T10:00:00Z'},
    {id:'co2',svcId:'s04',amount:75000,confidence:'exact',comment:'–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –§–∞—Ä–º–∞+ –∑–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ò–ò-–û–ö–ö',active:true,updatedAt:'2026-02-07T10:00:00Z'},
    {id:'co3',svcId:'s06',amount:120000,confidence:'exact',comment:'–ê–≤–∞–Ω—Å –õ–æ–≥–∏—Å—Ç–∏–∫ –∑–∞ –ò–ò-–ö–¶, 2-–π —ç—Ç–∞–ø –Ω–µ –Ω–∞—á–∞—Ç',active:true,updatedAt:'2026-02-07T10:00:00Z'},
  ];

  // Counterparty map ‚Äî demo
  cpMap={
    '–æ–æ–æ —Å—Ç—Ä–æ–π–º–∞—Å—Ç–µ—Ä':{t:'in',svcId:'s01',expTypeId:null},
    '–∏–ø –∫–æ–∑–ª–æ–≤':{t:'in',svcId:'s03',expTypeId:null},
    '–∫—Ü –ø—Ä–æ–º–µ—Ç–µ–π':{t:'out',svcId:null,expTypeId:'et03'},
    '–∏–ø —Å–∏–¥–æ—Ä–æ–≤–∞':{t:'out',svcId:null,expTypeId:'et02'},
    'planfix':{t:'out',svcId:null,expTypeId:'et06'},
    '–±—É—Ö—Å–µ—Ä–≤–∏—Å':{t:'out',svcId:null,expTypeId:'et08'},
  };

  toast('–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã','ok')
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="theme-toggle">
    <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">üåô –¢—ë–º–Ω–∞—è</button>
</div>
</div>
<script>
    // Auto-login for standalone demo
    localStorage.setItem('currentUser', JSON.stringify({email:'owner@fintablo.ru'}));

    // Theme toggle with persistence
    function toggleTheme(){
      const html=document.documentElement;
      const isLight=html.getAttribute('data-theme')==='light';
      html.setAttribute('data-theme',isLight?'dark':'light');
      document.getElementById('themeBtn').textContent=isLight?'üåô –¢—ë–º–Ω–∞—è':'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è';
      localStorage.setItem('ft_theme',isLight?'dark':'light');
      // Update header gradient for light mode
      const hdr=document.querySelector('.hdr');
      if(hdr)hdr.style.background=isLight?'':'linear-gradient(135deg,#f4f6f8,#ffffff)';
    }
    // Restore saved theme
    (function(){
      const saved=localStorage.getItem('ft_theme');
      if(saved==='light'){
        document.documentElement.setAttribute('data-theme','light');
        document.getElementById('themeBtn').textContent='‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è';
        const hdr=document.querySelector('.hdr');
        if(hdr)hdr.style.background='#ffffff';
      }
    })();
</script>
</body>
</html>
